<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#059669">
  <title>Colectas FULL</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f3f4f6; min-height: 100vh; padding-bottom: 80px; }
    .header { background: #059669; color: white; padding: 16px; text-align: center; }
    .header h1 { font-size: 18px; font-weight: 600; margin-bottom: 12px; }
    .header.with-tabs h1 { margin-bottom: 16px; }

    /* Main tabs in header - solo web */
    .main-tabs { display: none; gap: 8px; justify-content: center; }
    .main-tabs.show { display: flex; }
    .main-tab { flex: 1; max-width: 180px; padding: 14px 16px; background: rgba(255,255,255,0.15); color: white; border: 2px solid transparent; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 6px; transition: all 0.2s; }
    .main-tab:hover { background: rgba(255,255,255,0.25); }
    .main-tab.active { background: white; color: #059669; border-color: white; }
    .main-tab-icon { font-size: 24px; }
    .main-tab-text { font-size: 12px; }

    /* Main sections */
    .main-section { display: none; }
    .main-section.active { display: block; }

    .container { padding: 16px; max-width: 500px; margin: 0 auto; }

    /* Scan section */
    .scan-section { background: white; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .scan-input-group { display: flex; gap: 8px; }
    .scan-input { flex: 1; padding: 14px 16px; font-size: 16px; border: 2px solid #e5e7eb; border-radius: 8px; text-transform: uppercase; }
    .scan-input:focus { outline: none; border-color: #059669; }
    .scan-btn { padding: 14px 20px; background: #059669; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
    .scan-btn:disabled { background: #9ca3af; }

    /* Camera button - fixed at bottom */
    .camera-btn { position: fixed; bottom: 0; left: 0; right: 0; padding: 18px; background: #059669; color: white; border: none; font-size: 18px; font-weight: 600; cursor: pointer; z-index: 90; }

    /* Camera container */
    .camera-container { display: none; margin-top: 16px; position: relative; background: #000; border-radius: 12px; overflow: hidden; }
    .camera-container.active { display: block; }
    #video { width: 100%; display: block; }
    .close-camera { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 20px; cursor: pointer; z-index: 10; }
    .camera-guide { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70%; max-width: 280px; height: 80px; border: 3px solid rgba(255,255,255,0.8); border-radius: 8px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.3); pointer-events: none; }
    .camera-guide::before { content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 2px; background: rgba(255,0,0,0.5); }
    .camera-hint { position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; white-space: nowrap; }

    /* Status message */
    .status-message { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; display: none; }
    .status-message.show { display: block; }
    .status-message.error { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
    .status-message.loading { background: #ecfdf5; color: #059669; border: 1px solid #a7f3d0; }
    .status-message.success { background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }

    /* Items section */
    .items-section { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .items-header { padding: 16px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; }
    .items-header h2 { font-size: 16px; font-weight: 600; color: #374151; }
    .items-meta { font-size: 12px; color: #6b7280; margin-top: 4px; }
    .items-cuenta { display: inline-block; background: #d1fae5; color: #059669; padding: 2px 8px; border-radius: 4px; font-weight: 600; }
    .items-count { float: right; font-size: 14px; color: #6b7280; }

    /* Item card */
    .item-card { padding: 16px; padding-right: 80px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: flex-start; gap: 12px; transition: all 0.3s ease; position: relative; }
    .item-card:last-child { border-bottom: none; }
    .item-card.checked { background: #f0fdf4; }
    .item-card.just-scanned { background: #dcfce7; border-left: 4px solid #22c55e; }
    .item-card.verification-only { background: #fef3c7; border-left: 4px solid #f59e0b; }
    .item-card.verification-only.checked { background: #fef9c3; }

    .item-main-checkbox { width: 28px; height: 28px; cursor: pointer; flex-shrink: 0; margin-top: 4px; pointer-events: none; }
    .item-info { flex: 1; }
    .item-description { font-size: 20px; font-weight: 700; color: #111827; line-height: 1.3; }
    .item-sku { font-size: 14px; color: #6b7280; margin-top: 6px; font-family: monospace; }
    .item-quantity { font-size: 18px; color: #111827; font-weight: 700; margin-top: 8px; background: #fef3c7; padding: 6px 12px; border-radius: 6px; display: inline-block; }
    .item-kit-badge { display: inline-block; background: #dbeafe; color: #1d4ed8; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-left: 8px; vertical-align: middle; }

    /* Unit checkboxes */
    .unit-checkboxes { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #e5e7eb; }
    .unit-checkbox { width: 36px; height: 36px; cursor: pointer; accent-color: #22c55e; }
    .unit-checkbox.scanned { outline: 3px solid #7c3aed; outline-offset: 2px; }

    /* Verify photo button */
    .verify-photo-btn { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: #7c3aed; color: white; border: none; width: 56px; height: 56px; border-radius: 50%; font-size: 26px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(124,58,237,0.4); transition: all 0.2s; }
    .verify-photo-btn:hover { background: #6d28d9; transform: translateY(-50%) scale(1.1); }
    .verify-photo-btn:active { background: #5b21b6; transform: translateY(-50%) scale(0.95); }

    /* Vision result */
    .vision-result { background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 12px; margin: 12px 16px; }
    .vision-result.correct { background: #dcfce7; border-color: #22c55e; }
    .vision-result.incorrect { background: #fee2e2; border-color: #ef4444; }
    .vision-result h4 { margin-bottom: 8px; }
    .vision-result p { font-size: 13px; margin: 4px 0; }

    /* Vision camera modal */
    .vision-camera-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 1000; display: flex; flex-direction: column; }
    .vision-camera-modal.hidden { display: none; }
    .vision-camera-header { padding: 16px; background: #1f2937; color: white; display: flex; justify-content: space-between; align-items: center; }
    .vision-camera-header h3 { font-size: 16px; margin: 0; }
    .vision-camera-close { background: none; border: none; color: white; font-size: 28px; cursor: pointer; padding: 0 8px; }
    .vision-camera-body { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
    #visionVideo { max-width: 100%; max-height: 100%; object-fit: contain; }
    .vision-camera-footer { padding: 20px; background: #1f2937; display: flex; justify-content: center; gap: 16px; }
    .vision-analyze-btn { background: #7c3aed; color: white; border: none; padding: 16px 48px; border-radius: 30px; font-size: 18px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px; }
    .vision-analyze-btn:disabled { background: #6b7280; cursor: not-allowed; }
    .vision-product-info { position: absolute; top: 16px; left: 16px; right: 16px; background: rgba(0,0,0,0.8); color: white; padding: 12px; border-radius: 8px; font-size: 14px; }
    .vision-product-info strong { color: #a78bfa; }

    /* Complete banner */
    .complete-banner { display: none; position: fixed; bottom: 56px; left: 0; right: 0; background: #22c55e; color: white; padding: 20px; text-align: center; font-size: 18px; font-weight: 600; z-index: 100; }
    .complete-banner.show { display: block; }

    /* Reset button */
    .reset-btn { width: 100%; padding: 14px; margin-top: 16px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }

    /* Scanned items dropdown */
    .scanned-dropdown { background: white; border-radius: 12px; margin-top: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
    .scanned-dropdown.hidden { display: none; }
    .scanned-dropdown-header { padding: 14px 16px; background: #f3f4f6; display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; }
    .scanned-dropdown-header h3 { font-size: 15px; font-weight: 600; color: #374151; margin: 0; display: flex; align-items: center; gap: 8px; }
    .scanned-dropdown-toggle { font-size: 12px; color: #6b7280; transition: transform 0.2s; }
    .scanned-dropdown.open .scanned-dropdown-toggle { transform: rotate(180deg); }
    .scanned-dropdown-badge { background: #059669; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: 600; }
    .scanned-dropdown-badge.pending { background: #f59e0b; }
    .scanned-dropdown-list { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
    .scanned-dropdown.open .scanned-dropdown-list { max-height: 400px; overflow-y: auto; }
    .scanned-item { padding: 12px 16px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
    .scanned-item-info { flex: 1; }
    .scanned-item-code { font-size: 13px; font-weight: 600; color: #111827; font-family: monospace; }
    .scanned-item-desc { font-size: 12px; color: #6b7280; margin-top: 2px; }
    .scanned-item-status { text-align: right; }
    .scanned-item-count { font-size: 14px; font-weight: 700; }
    .scanned-item-count.complete { color: #22c55e; }
    .scanned-item-count.partial { color: #f59e0b; }
    .scanned-item-count.pending { color: #9ca3af; }
    .scanned-item-label { font-size: 10px; color: #6b7280; text-transform: uppercase; }
    .scanned-item-actions { display: flex; align-items: center; gap: 8px; }
    .scanned-item-btn { width: 32px; height: 32px; border-radius: 50%; border: none; font-size: 18px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .scanned-item-btn.plus { background: #22c55e; color: white; }
    .scanned-item-btn.plus:hover { background: #16a34a; }
    .scanned-item-btn.minus { background: #ef4444; color: white; }
    .scanned-item-btn.minus:hover { background: #dc2626; }
    .scanned-item-btn:disabled { background: #d1d5db; color: #9ca3af; cursor: not-allowed; }

    /* Toast para feedback r√°pido (web con lector) */
    .scan-toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8); background: #22c55e; color: white; padding: 24px 48px; border-radius: 16px; font-size: 24px; font-weight: 700; text-align: center; z-index: 2000; opacity: 0; transition: all 0.2s ease; pointer-events: none; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
    .scan-toast.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    .scan-toast.error { background: #ef4444; }
    .scan-toast.confirm { background: #3b82f6; }
    .scan-toast.warning { background: #f59e0b; }
    .scan-toast-code { font-size: 14px; font-weight: 400; margin-top: 8px; opacity: 0.9; font-family: monospace; }
    .scan-toast-count { font-size: 16px; font-weight: 500; margin-top: 4px; }

    /* Input dedicado para escaneo web (lector de c√≥digo de barras) */
    .web-scanner-section { background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); border-radius: 16px; padding: 24px; margin-bottom: 16px; text-align: center; }
    .web-scanner-section.hidden { display: none; }
    .web-scanner-title { color: #94a3b8; font-size: 14px; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; }
    .web-scanner-input { width: 100%; padding: 20px; font-size: 24px; font-family: monospace; text-align: center; border: 3px solid #3b82f6; border-radius: 12px; background: #0f172a; color: white; outline: none; transition: all 0.2s; }
    .web-scanner-input:focus { border-color: #22c55e; box-shadow: 0 0 20px rgba(34, 197, 94, 0.3); }
    .web-scanner-input::placeholder { color: #475569; }
    .web-scanner-hint { color: #64748b; font-size: 13px; margin-top: 12px; }
    .web-scanner-status { margin-top: 16px; padding: 12px; border-radius: 8px; font-weight: 600; }
    .web-scanner-status.ready { background: #166534; color: #86efac; }
    .web-scanner-status.no-colecta { background: #7f1d1d; color: #fca5a5; }

    /* Panel de verificaci√≥n de producto (web) */
    .verify-panel { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #0f172a; z-index: 2000; display: flex; flex-direction: column; }
    .verify-panel.hidden { display: none; }
    .verify-panel-header { background: #1e293b; padding: 20px 24px; border-bottom: 2px solid #334155; position: relative; }
    .verify-panel-delete { position: absolute; top: 20px; right: 24px; background: #dc2626; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; }
    .verify-panel-delete:hover { background: #b91c1c; }
    .verify-panel-delete:active { background: #991b1b; }
    .verify-panel-code { font-family: monospace; font-size: 18px; color: #94a3b8; margin-bottom: 8px; }
    .verify-panel-title { font-size: 32px; font-weight: 700; color: white; line-height: 1.2; }
    .verify-panel-sku { font-size: 16px; color: #64748b; margin-top: 8px; font-family: monospace; }
    .verify-panel-body { flex: 1; padding: 24px; overflow-y: auto; }
    .verify-panel-instruction { text-align: center; color: #94a3b8; font-size: 18px; margin-bottom: 24px; padding: 16px; background: #1e293b; border-radius: 12px; }
    .verify-panel-instruction strong { color: #fbbf24; }
    .verify-panel-items { display: flex; flex-direction: column; gap: 16px; }
    .verify-panel-item { background: #1e293b; border: 3px solid #334155; border-radius: 16px; padding: 24px; display: flex; align-items: center; gap: 20px; transition: all 0.3s; }
    .verify-panel-item.confirmed { background: #14532d; border-color: #22c55e; }
    .verify-panel-item.current { border-color: #fbbf24; box-shadow: 0 0 20px rgba(251, 191, 36, 0.3); }
    .verify-panel-item-check { width: 48px; height: 48px; border-radius: 50%; border: 3px solid #475569; display: flex; align-items: center; justify-content: center; font-size: 28px; flex-shrink: 0; }
    .verify-panel-item.confirmed .verify-panel-item-check { background: #22c55e; border-color: #22c55e; color: white; }
    .verify-panel-item-info { flex: 1; }
    .verify-panel-item-name { font-size: 24px; font-weight: 600; color: white; }
    .verify-panel-item-detail { font-size: 14px; color: #94a3b8; margin-top: 4px; }
    .verify-panel-item-qty { font-size: 20px; font-weight: 700; color: #fbbf24; background: #1e293b; padding: 8px 16px; border-radius: 8px; }
    .verify-panel-item.confirmed .verify-panel-item-qty { color: #86efac; }
    .verify-panel-footer { background: #1e293b; padding: 20px 24px; border-top: 2px solid #334155; }
    .verify-panel-progress { display: flex; align-items: center; gap: 16px; }
    .verify-panel-progress-bar { flex: 1; height: 12px; background: #334155; border-radius: 6px; overflow: hidden; }
    .verify-panel-progress-fill { height: 100%; background: #22c55e; transition: width 0.3s; }
    .verify-panel-progress-text { font-size: 18px; font-weight: 600; color: white; min-width: 80px; text-align: right; }

    .hidden { display: none !important; }

    /* Login */
    .login-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #059669 0%, #047857 100%); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .login-overlay.hidden { display: none; }
    .login-box { background: white; border-radius: 16px; padding: 32px; max-width: 360px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .login-logo { text-align: center; margin-bottom: 24px; }
    .login-logo h1 { font-size: 24px; color: #059669; margin-bottom: 8px; }
    .login-logo p { font-size: 14px; color: #6b7280; }
    .login-form { display: flex; flex-direction: column; gap: 16px; }
    .login-input { padding: 14px 16px; font-size: 16px; border: 2px solid #e5e7eb; border-radius: 8px; outline: none; transition: border-color 0.2s; }
    .login-input:focus { border-color: #059669; }
    .login-btn { padding: 14px 20px; background: #059669; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
    .login-btn:hover { background: #047857; }
    .login-btn:disabled { background: #9ca3af; cursor: not-allowed; }
    .login-error { background: #fef2f2; color: #dc2626; padding: 12px; border-radius: 8px; font-size: 14px; text-align: center; display: none; }
    .login-error.show { display: block; }
    .logout-btn { position: fixed; top: 12px; right: 12px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; z-index: 101; }
    .logout-btn:hover { background: rgba(255,255,255,0.3); }
    .logout-btn.hidden { display: none; }

    /* Colectas panel */
    .colectas-panel { background: white; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
    .colectas-header { background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%); color: white; padding: 16px; display: flex; justify-content: space-between; align-items: center; }
    .colectas-header h2 { font-size: 16px; font-weight: 700; margin: 0; }
    .colectas-tabs { display: flex; gap: 8px; }
    .colectas-tab { background: rgba(255,255,255,0.2); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; }
    .colectas-tab.active { background: white; color: #4f46e5; }
    .colectas-count { background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 8px; }

    /* Lista de colectas */
    .colectas-list { max-height: 300px; overflow-y: auto; }
    .colecta-item { padding: 12px 16px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: background 0.2s; }
    .colecta-item:hover { background: #f9fafb; }
    .colecta-item:last-child { border-bottom: none; }
    .colecta-item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    .colecta-item-principal { display: flex; flex-direction: column; gap: 2px; }
    .colecta-item-cuenta-grande { font-size: 18px; font-weight: 700; color: #1d4ed8; }
    .colecta-item-fecha-grande { font-size: 16px; font-weight: 600; color: #111827; }
    .colecta-item-envio { font-size: 12px; color: #6b7280; text-align: right; }
    .colecta-item-name { font-weight: 600; color: #111827; font-size: 14px; }
    .colecta-item-cuenta { background: #dbeafe; color: #1d4ed8; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
    .colecta-item-dates { font-size: 12px; color: #6b7280; margin-bottom: 8px; }
    .colecta-item-progress { background: #e5e7eb; border-radius: 4px; height: 8px; overflow: hidden; }
    .colecta-item-progress-bar { background: #22c55e; height: 100%; transition: width 0.3s; }
    .colecta-item-stats { display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: #6b7280; }
    .colecta-item-actions { display: flex; gap: 8px; margin-top: 8px; }
    .colecta-item-btn { padding: 6px 12px; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; }
    .colecta-item-btn.edit { background: #e5e7eb; color: #374151; }
    .colecta-item-btn.delete { background: #fee2e2; color: #dc2626; }

    /* Calendario */
    .colectas-calendar { padding: 12px; }
    .calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .calendar-nav-btn { background: #e5e7eb; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 18px; cursor: pointer; }
    .calendar-nav-btn:hover { background: #d1d5db; }
    .calendar-month { font-size: 16px; font-weight: 600; color: #111827; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .calendar-weekday { text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; padding: 8px 0; }
    .calendar-cell { background: #f9fafb; border-radius: 6px; display: flex; flex-direction: column; align-items: stretch; padding: 4px; font-size: 12px; cursor: pointer; position: relative; min-height: 70px; }
    .calendar-cell:hover { background: #e5e7eb; }
    .calendar-cell.other-month { background: transparent; color: #d1d5db; min-height: 40px; }
    .calendar-cell.today { background: #dbeafe; font-weight: 700; }
    .calendar-cell.has-colecta { background: #fff; border: 2px solid #e5e7eb; }
    .calendar-cell-day { font-weight: 500; text-align: center; margin-bottom: 2px; }
    .calendar-cell-colectas { display: flex; flex-direction: column; gap: 2px; overflow: hidden; }
    .calendar-cell-colecta { font-size: 9px; padding: 2px 4px; border-radius: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .calendar-cell-colecta.pending { background: #fef3c7; color: #92400e; }
    .calendar-cell-colecta.complete { background: #dcfce7; color: #166534; }
    .calendar-day-detail { background: #f3f4f6; border-radius: 8px; padding: 12px; margin-top: 12px; }
    .calendar-day-detail-header { font-weight: 600; color: #4f46e5; margin-bottom: 8px; font-size: 14px; }
    .calendar-day-detail-items { display: flex; flex-direction: column; gap: 8px; }
    .calendar-detail-item { background: white; border-radius: 6px; padding: 10px; border-left: 4px solid #4f46e5; cursor: pointer; }
    .calendar-detail-item:hover { background: #f9fafb; }
    .calendar-detail-item.complete { border-left-color: #22c55e; }
    .calendar-detail-item-header { display: flex; justify-content: space-between; align-items: center; }
    .calendar-detail-item-cuenta { font-weight: 600; color: #1d4ed8; }
    .calendar-detail-item-envio { font-size: 11px; color: #6b7280; }
    .calendar-detail-item-stats { font-size: 12px; color: #374151; margin-top: 4px; }

    /* Upload colecta */
    .colecta-upload { background: #f9fafb; padding: 16px; border-top: 1px solid #e5e7eb; }
    .colecta-upload.hidden { display: none; }
    .colecta-upload h3 { font-size: 14px; margin-bottom: 12px; color: #374151; }
    .colecta-upload-form { display: flex; flex-direction: column; gap: 10px; }
    .colecta-upload-form label { font-size: 12px; color: #6b7280; }
    .colecta-upload-form input, .colecta-upload-form select { padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; }
    .colecta-upload-form input[type="file"] { border-style: dashed; background: white; }
    .colecta-upload-btn { padding: 12px; background: #4f46e5; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; }
    .colecta-upload-btn:disabled { background: #9ca3af; }
    .toggle-upload-btn { width: 100%; padding: 12px; background: #4f46e5; color: white; border: none; font-size: 14px; font-weight: 600; cursor: pointer; }

    /* Status badges */
    .colecta-status-badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; margin-left: 8px; }
    .colecta-status-badge.en-colecta { background: #dcfce7; color: #16a34a; }
    .colecta-status-badge.no-colecta { background: #fef2f2; color: #dc2626; }
    .colecta-status-badge.verificado { background: #dbeafe; color: #1d4ed8; }

    .empty-state { text-align: center; padding: 32px 16px; color: #6b7280; }
    .empty-state p { margin-bottom: 12px; }

    /* Vista Verificar */
    .colectas-verificar { padding: 16px; }
    .colectas-verificar.hidden { display: none; }
    .verificar-selector { margin-bottom: 16px; }
    .verificar-selector label { display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px; }
    .verificar-selector select { width: 100%; padding: 12px; font-size: 16px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; }
    .verificar-selector select:focus { outline: none; border-color: #4f46e5; }
    .verificar-colecta-info { background: #f9fafb; border-radius: 8px; padding: 16px; }
    .verificar-colecta-info.hidden { display: none; }
    .verificar-colecta-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    .verificar-colecta-cuenta { font-size: 24px; font-weight: 700; color: #4f46e5; }
    .verificar-colecta-fecha { font-size: 16px; color: #374151; }
    .verificar-colecta-estado { font-size: 12px; padding: 4px 12px; border-radius: 20px; font-weight: 600; }
    .verificar-colecta-estado.pending { background: #fef3c7; color: #92400e; }
    .verificar-colecta-estado.complete { background: #dcfce7; color: #166534; }
    .verificar-progress { margin: 16px 0; }
    .verificar-progress-bar { background: #e5e7eb; height: 16px; border-radius: 8px; overflow: hidden; }
    .verificar-progress-fill { background: linear-gradient(90deg, #4f46e5, #22c55e); height: 100%; transition: width 0.3s; }
    .verificar-progress-text { text-align: center; margin-top: 8px; font-size: 18px; font-weight: 700; color: #111827; }
    .verificar-mensaje { text-align: center; padding: 20px; color: #6b7280; font-size: 14px; }

    /* Modal de detalle de colecta */
    .colecta-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 16px; }
    .colecta-modal.hidden { display: none; }
    .colecta-modal-content { background: white; border-radius: 12px; max-width: 500px; width: 100%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
    .colecta-modal-header { background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%); color: white; padding: 16px; display: flex; justify-content: space-between; align-items: center; }
    .colecta-modal-header h3 { margin: 0; font-size: 16px; }
    .colecta-modal-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; font-size: 18px; cursor: pointer; }
    .colecta-modal-info { padding: 16px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; }
    .colecta-modal-info p { margin: 4px 0; font-size: 14px; color: #374151; }
    .colecta-modal-progress { padding: 12px 16px; background: #f3f4f6; }
    .colecta-modal-progress-bar { background: #e5e7eb; height: 12px; border-radius: 6px; overflow: hidden; }
    .colecta-modal-progress-fill { background: #22c55e; height: 100%; transition: width 0.3s; }
    .colecta-modal-progress-text { text-align: center; margin-top: 8px; font-size: 14px; font-weight: 600; color: #374151; }
    .colecta-modal-items { flex: 1; overflow-y: auto; padding: 8px; }
    .colecta-modal-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-bottom: 1px solid #e5e7eb; font-size: 13px; gap: 8px; }
    .colecta-modal-item:last-child { border-bottom: none; }
    .colecta-modal-item.verificado { background: #f0fdf4; }
    .colecta-modal-item-info { flex: 1; min-width: 0; }
    .colecta-modal-item-nombre { display: block; font-size: 14px; font-weight: 600; color: #111827; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .colecta-modal-item-codigo { display: block; font-family: monospace; font-size: 11px; color: #6b7280; margin-top: 2px; }
    .colecta-modal-item-cant { background: #fef3c7; padding: 2px 8px; border-radius: 4px; font-weight: 600; white-space: nowrap; }
    .colecta-modal-item-status { font-size: 16px; }

    /* Secci√≥n Transferencia Stock - Solo Web */
    .transfer-section { background: white; border-radius: 12px; padding: 20px; margin-top: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 2px solid #8b5cf6; }
    .transfer-section.hidden { display: none; }
    .transfer-section h2 { font-size: 16px; font-weight: 600; color: #8b5cf6; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .transfer-section h2::before { content: 'üíª'; }
    .transfer-web-only { font-size: 10px; background: #8b5cf6; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 500; }
    .transfer-steps { display: flex; flex-direction: column; gap: 16px; }
    .transfer-step { border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; }
    .transfer-step-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .transfer-step-num { width: 24px; height: 24px; background: #8b5cf6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; }
    .transfer-step-title { font-weight: 600; color: #374151; }
    .transfer-step input[type="file"] { width: 100%; font-size: 14px; }
    .transfer-step-status { margin-top: 8px; font-size: 12px; color: #059669; display: none; }
    .transfer-step-status.show { display: block; }
    .transfer-step-status.error { color: #dc2626; }
    .transfer-btn { width: 100%; padding: 14px; background: #8b5cf6; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 8px; }
    .transfer-btn:disabled { background: #9ca3af; cursor: not-allowed; }
    .transfer-btn:hover:not(:disabled) { background: #7c3aed; }
    .transfer-results { margin-top: 16px; }
    .transfer-result-box { padding: 12px; border-radius: 8px; margin-bottom: 8px; font-size: 13px; }
    .transfer-result-box.success { background: #dcfce7; border: 1px solid #86efac; }
    .transfer-result-box.error { background: #fee2e2; border: 1px solid #fecaca; }
    .transfer-result-box.warning { background: #fef3c7; border: 1px solid #fde68a; }
    .transfer-result-box h4 { margin-bottom: 8px; font-size: 14px; }
    .transfer-result-box ul { margin: 0; padding-left: 20px; max-height: 150px; overflow-y: auto; }
    .transfer-result-box li { margin: 4px 0; }
    .transfer-download-btn { width: 100%; padding: 12px; background: #059669; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; margin-top: 12px; }
    .transfer-download-btn:hover { background: #047857; }
    .transfer-validation { padding: 10px; border-radius: 6px; margin-top: 8px; font-size: 12px; }
    .transfer-validation.ok { background: #dcfce7; color: #166534; }
    .transfer-validation.error { background: #fee2e2; color: #991b1b; }

    /* Transfer en secci√≥n Creaci√≥n - m√°s prominente */
    #sectionCreacion .transfer-section { border: none; margin-top: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    #sectionCreacion .transfer-section h2::before { content: ''; }

    /* Plantilla download link */
    .plantilla-download-link { display: block; text-align: center; padding: 10px 16px; margin-bottom: 12px; background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; color: #166534; font-size: 13px; font-weight: 500; text-decoration: none; transition: all 0.2s; }
    .plantilla-download-link:hover { background: #dcfce7; border-color: #4ade80; }

    /* Creaci√≥n - Tabs internos */
    .creacion-tabs { display: flex; gap: 8px; margin-bottom: 16px; }
    .creacion-tab { flex: 1; padding: 12px; background: #f3f4f6; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; text-align: center; transition: all 0.2s; }
    .creacion-tab:hover { background: #e5e7eb; }
    .creacion-tab.active { background: #8b5cf6; color: white; border-color: #8b5cf6; }
    .creacion-tab-icon { font-size: 20px; display: block; margin-bottom: 4px; }
    .creacion-content { display: none; }
    .creacion-content.active { display: block; }

    /* Planificador */
    .planner-section { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .planner-section h2 { font-size: 16px; font-weight: 600; color: #2563eb; margin-bottom: 8px; }
    .planner-section p { font-size: 13px; color: #6b7280; margin-bottom: 16px; }
    .planner-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 12px; }
    .planner-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
    .planner-file-box { border: 1px dashed #d1d5db; border-radius: 8px; padding: 10px; background: #f9fafb; }
    .planner-file-box label { display: block; font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 6px; }
    .planner-file-box input[type="file"] { width: 100%; font-size: 11px; }
    .planner-file-box .file-status { font-size: 11px; color: #059669; margin-top: 4px; }
    .planner-file-box .file-status.error { color: #dc2626; }
    .planner-buttons { display: flex; gap: 8px; margin-bottom: 16px; }
    .planner-btn { padding: 12px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
    .planner-btn.primary { background: #2563eb; color: white; }
    .planner-btn.primary:disabled { background: #9ca3af; cursor: not-allowed; }
    .planner-btn.success { background: #059669; color: white; }
    .planner-warnings { background: #fef3c7; border: 1px solid #fde68a; border-radius: 8px; padding: 12px; margin-bottom: 16px; }
    .planner-warnings h4 { font-size: 13px; font-weight: 600; color: #92400e; margin-bottom: 8px; }
    .planner-warnings-list { max-height: 100px; overflow-y: auto; font-size: 12px; color: #78350f; }
    .planner-results { border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; }
    .planner-results-header { background: #f3f4f6; padding: 12px; font-size: 13px; font-weight: 600; color: #374151; display: flex; justify-content: space-between; }
    .planner-validation { background: #eff6ff; padding: 10px 12px; border-top: 1px solid #e5e7eb; font-size: 11px; color: #1e40af; }
    .planner-table-wrap { max-height: 300px; overflow-y: auto; }
    .planner-table { width: 100%; font-size: 11px; border-collapse: collapse; }
    .planner-table th { background: #f9fafb; padding: 8px 6px; text-align: left; font-weight: 600; color: #374151; position: sticky; top: 0; }
    .planner-table td { padding: 6px; border-bottom: 1px solid #f3f4f6; }
    .planner-table tr:hover { background: #f9fafb; }
    .planner-table .text-right { text-align: right; }
    .planner-table .font-bold { font-weight: 700; }
    .planner-table .font-mono { font-family: monospace; }
    .planner-cat { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; }
    .planner-cat.ok { background: #dcfce7; color: #166534; }
    .planner-cat.insuficiente { background: #fee2e2; color: #991b1b; }
    .planner-cat.noEncontrado { background: #f3f4f6; color: #374151; }
    .planner-cat.sinRecomendacion { background: #fef3c7; color: #92400e; }
    .planner-cat.sinSku { background: #f3e8ff; color: #6b21a8; }
    .planner-cat.excluir { background: #f3f4f6; color: #6b7280; }

    /* Celebraci√≥n de colecta completada */
    .celebration-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .celebration-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    .celebration-text {
      font-size: 48px;
      font-weight: 900;
      color: #22c55e;
      text-align: center;
      text-shadow: 0 0 20px rgba(34, 197, 94, 0.5), 0 0 40px rgba(34, 197, 94, 0.3);
      animation: celebrationPulse 0.5s ease-in-out infinite alternate;
      padding: 20px;
      line-height: 1.2;
    }
    .celebration-subtext {
      font-size: 24px;
      color: white;
      margin-top: 16px;
      opacity: 0.9;
    }
    @keyframes celebrationPulse {
      from { transform: scale(1); }
      to { transform: scale(1.05); }
    }
    .confetti-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10000;
      overflow: hidden;
    }
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      opacity: 0;
    }
    @keyframes confettiFall {
      0% {
        opacity: 1;
        transform: translateY(-10px) rotate(0deg);
      }
      100% {
        opacity: 0;
        transform: translateY(100vh) rotate(720deg);
      }
    }

    /* Alerta de todas las unidades escaneadas */
    .all-scanned-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(220, 38, 38, 0.95);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .all-scanned-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    .all-scanned-text {
      font-size: 42px;
      font-weight: 900;
      color: white;
      text-align: center;
      text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      animation: allScannedPulse 0.4s ease-in-out infinite alternate;
      padding: 30px;
      line-height: 1.3;
    }
    .all-scanned-icon {
      font-size: 80px;
      margin-bottom: 20px;
      animation: allScannedBounce 0.5s ease-in-out infinite alternate;
    }
    .all-scanned-subtext {
      font-size: 20px;
      color: rgba(255, 255, 255, 0.9);
      margin-top: 20px;
      text-align: center;
    }
    @keyframes allScannedPulse {
      from { transform: scale(1); }
      to { transform: scale(1.08); }
    }
    @keyframes allScannedBounce {
      from { transform: translateY(0); }
      to { transform: translateY(-10px); }
    }
  </style>
</head>
<body>
  <!-- Login Overlay -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-box">
      <div class="login-logo">
        <h1>Colectas FULL</h1>
        <p>Inicia sesion para continuar</p>
      </div>
      <form class="login-form" id="loginForm">
        <input type="text" class="login-input" id="loginUser" placeholder="Usuario" autocomplete="username" required>
        <input type="password" class="login-input" id="loginPassword" placeholder="Contrasena" autocomplete="current-password" required>
        <div class="login-error" id="loginError">Usuario o contrasena incorrectos</div>
        <button type="submit" class="login-btn" id="loginBtn">Iniciar Sesion</button>
      </form>
    </div>
  </div>

  <!-- Celebration Overlay -->
  <div class="celebration-overlay" id="celebrationOverlay">
    <div class="celebration-text" id="celebrationText">COLECTA<br>COMPLETADA</div>
    <div class="celebration-subtext" id="celebrationSubtext"></div>
  </div>
  <div class="confetti-container" id="confettiContainer"></div>

  <!-- All Scanned Alert Overlay -->
  <div class="all-scanned-overlay" id="allScannedOverlay">
    <div class="all-scanned-icon">‚ö†Ô∏è</div>
    <div class="all-scanned-text">TODAS LAS UNIDADES<br>YA ESTAN ESCANEADAS</div>
    <div class="all-scanned-subtext" id="allScannedSubtext"></div>
  </div>

  <!-- Logout Button -->
  <button type="button" class="logout-btn hidden" id="logoutBtn">Salir</button>

  <div class="header" id="mainHeader">
    <h1>Colectas FULL</h1>
    <div class="main-tabs" id="mainTabs">
      <button type="button" class="main-tab" data-section="creacion">
        <span class="main-tab-icon">üì¶</span>
        <span class="main-tab-text">Creaci√≥n</span>
      </button>
      <button type="button" class="main-tab active" data-section="seguimiento">
        <span class="main-tab-icon">üìã</span>
        <span class="main-tab-text">Seguimiento</span>
      </button>
    </div>
  </div>

  <div class="container">
    <!-- SECCI√ìN: Creaci√≥n de Colectas (solo web) -->
    <div class="main-section" id="sectionCreacion">
      <!-- Descargar plantilla ML -->
      <a href="/plantilla-ml.xlsx" download="Excel para subir a ML.xlsx" class="plantilla-download-link">
        üì• Descargar plantilla Excel para MercadoLibre
      </a>

      <!-- Tabs internos -->
      <div class="creacion-tabs">
        <button type="button" class="creacion-tab active" data-tab="planificador">
          <span class="creacion-tab-icon">üìä</span>
          1. Planificador
        </button>
        <button type="button" class="creacion-tab" data-tab="transferencia">
          <span class="creacion-tab-icon">üîÑ</span>
          2. Transferencia
        </button>
      </div>

      <!-- Tab: Planificador -->
      <div class="creacion-content active" id="tabPlanificador">
        <div class="planner-section">
          <h2>üìä Planificador de Env√≠os FULL</h2>
          <p>Calcul√° cu√°ntas unidades enviar seg√∫n las sugerencias de MeLi, tu stock disponible y ventas mayoristas.</p>

          <div class="planner-grid">
            <div class="planner-file-box">
              <label>MeLi Cuenta 1</label>
              <input type="file" id="plannerMeli1" accept=".xlsx,.xls">
              <div class="file-status" id="plannerMeli1Status"></div>
            </div>
            <div class="planner-file-box">
              <label>MeLi Cuenta 2</label>
              <input type="file" id="plannerMeli2" accept=".xlsx,.xls">
              <div class="file-status" id="plannerMeli2Status"></div>
            </div>
            <div class="planner-file-box">
              <label>MeLi Cuenta 3</label>
              <input type="file" id="plannerMeli3" accept=".xlsx,.xls">
              <div class="file-status" id="plannerMeli3Status"></div>
            </div>
          </div>

          <div class="planner-grid-2">
            <div class="planner-file-box">
              <label>Stock ERP *</label>
              <input type="file" id="plannerStock" accept=".xlsx,.xls">
              <div class="file-status" id="plannerStockStatus"></div>
            </div>
            <div class="planner-file-box">
              <label>Mayorista (opcional)</label>
              <input type="file" id="plannerMayorista" accept=".xlsx,.xls">
              <div class="file-status" id="plannerMayoristaStatus"></div>
            </div>
          </div>

          <div class="planner-buttons">
            <button type="button" class="planner-btn primary" id="plannerProcessBtn" disabled>Procesar</button>
            <button type="button" class="planner-btn success hidden" id="plannerExportBtn">Exportar Excel</button>
          </div>

          <div class="planner-warnings hidden" id="plannerWarnings">
            <h4>‚ö†Ô∏è SKUs no encontrados</h4>
            <div class="planner-warnings-list" id="plannerWarningsList"></div>
          </div>

          <div class="planner-results hidden" id="plannerResults">
            <div class="planner-results-header">
              <span id="plannerResultsCount">0 productos</span>
              <span>Sugeridas: <strong id="plannerSugeridas">0</strong> | A enviar: <strong id="plannerAEnviar">0</strong></span>
            </div>
            <div class="planner-validation" id="plannerValidation"></div>
            <div class="planner-table-wrap">
              <table class="planner-table">
                <thead>
                  <tr>
                    <th>Estado</th>
                    <th>Cuenta</th>
                    <th>SKU</th>
                    <th>Rec.</th>
                    <th class="text-right">Sug.</th>
                    <th class="text-right">Disp.</th>
                    <th class="text-right">Enviar</th>
                    <th class="text-right">May.</th>
                    <th class="text-right">Rest.</th>
                  </tr>
                </thead>
                <tbody id="plannerTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab: Transferencia -->
      <div class="creacion-content" id="tabTransferencia">
        <div class="transfer-section" id="transferSectionCreacion" style="margin-top: 0; display: block;">
          <h2>üîÑ Transferencia de Stock</h2>
          <p style="font-size: 13px; color: #6b7280; margin-bottom: 16px;">Transfer√≠ stock del Dep√≥sito 1 al Dep√≥sito 2 bas√°ndote en un env√≠o FULL.</p>
          <div class="transfer-steps">
            <div class="transfer-step">
              <div class="transfer-step-header">
                <span class="transfer-step-num">1</span>
                <span class="transfer-step-title">PDF del Env√≠o FULL</span>
              </div>
              <input type="file" id="transferPdfInput2" accept=".pdf">
              <div class="transfer-step-status" id="transferPdfStatus2"></div>
              <div class="transfer-validation hidden" id="transferPdfValidation2"></div>
            </div>

            <div class="transfer-step">
              <div class="transfer-step-header">
                <span class="transfer-step-num">2</span>
                <span class="transfer-step-title">Excel de Stock (ERP)</span>
              </div>
              <input type="file" id="transferStockInput2" accept=".xlsx,.xls,.csv">
              <div class="transfer-step-status" id="transferStockStatus2"></div>
            </div>

            <button type="button" class="transfer-btn" id="transferProcessBtn2" disabled>
              Procesar Transferencia (Dep1 ‚Üí Dep2)
            </button>

            <div class="transfer-results hidden" id="transferResults2">
              <div class="transfer-result-box success hidden" id="transferSuccess2">
                <h4>‚úì Transferencias exitosas</h4>
                <ul id="transferSuccessList2"></ul>
              </div>
              <div class="transfer-result-box error hidden" id="transferErrors2">
                <h4>‚úó Stock insuficiente</h4>
                <ul id="transferErrorsList2"></ul>
              </div>
              <div class="transfer-result-box warning hidden" id="transferNotFound2">
                <h4>‚ö† SKUs no encontrados</h4>
                <ul id="transferNotFoundList2"></ul>
              </div>
              <button type="button" class="transfer-download-btn hidden" id="transferDownloadBtn2">
                ‚¨á Descargar Stock Actualizado (.xlsx)
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SECCI√ìN: Seguimiento (default) -->
    <div class="main-section active" id="sectionSeguimiento">
    <!-- Panel de Colectas -->
    <div class="colectas-panel" id="colectasPanel">
      <div class="colectas-header">
        <h2>Colectas FULL <span class="colectas-count" id="colectasCount">0</span></h2>
        <div class="colectas-tabs">
          <button type="button" class="colectas-tab" data-view="lista" id="tabLista">Lista</button>
          <button type="button" class="colectas-tab" data-view="calendario" id="tabCalendario">Calendario</button>
          <button type="button" class="colectas-tab active" data-view="verificar" id="tabVerificar">Verificar</button>
        </div>
      </div>

      <!-- Vista Lista -->
      <div class="colectas-list hidden" id="colectasLista"></div>

      <!-- Vista Calendario -->
      <div class="colectas-calendar hidden" id="colectasCalendario"></div>

      <!-- Vista Verificar -->
      <div class="colectas-verificar" id="colectasVerificar">
        <div class="verificar-selector">
          <label>Seleccion√° la colecta a verificar:</label>
          <select id="colectaActivaSelect">
            <option value="">-- Elegir colecta --</option>
          </select>
        </div>
        <div class="verificar-colecta-info hidden" id="verificarColectaInfo"></div>
      </div>

      <!-- Boton para mostrar formulario -->
      <button type="button" class="toggle-upload-btn" id="toggleUploadBtn">+ Nueva Colecta</button>

      <!-- Formulario de carga -->
      <div class="colecta-upload hidden" id="colectaUpload">
        <h3>Cargar nueva colecta</h3>
        <form class="colecta-upload-form" id="colectaForm">
          <label>Cuenta:</label>
          <select id="colectaCuentaInput">
            <option value="">Seleccionar cuenta...</option>
            <option value="Furst">Furst</option>
            <option value="Tienda">Tienda</option>
            <option value="Shop">Shop</option>
            <option value="Mun1">Mun1</option>
            <option value="Mun2">Mun2</option>
          </select>
          <label>Fecha de retiro:</label>
          <input type="date" id="colectaFechaInput" required>
          <label>PDF de la colecta FULL:</label>
          <input type="file" id="colectaPdfInput" accept=".pdf" required>
          <button type="submit" class="colecta-upload-btn" id="colectaUploadBtn">Cargar colecta</button>
        </form>
      </div>
    </div>

    <div class="scan-section">
      <div class="scan-input-group">
        <input type="text" id="codigoInput" class="scan-input" placeholder="Codigo ML...">
        <button type="button" id="searchBtn" class="scan-btn">Buscar</button>
      </div>
      <div class="camera-container" id="cameraContainer">
        <video id="video" playsinline></video>
        <div class="camera-guide"></div>
        <div class="camera-hint">Centra el codigo en el recuadro</div>
        <button type="button" class="close-camera" id="closeCamera">‚úï</button>
      </div>
    </div>

    <div class="status-message" id="statusMessage"></div>

    <!-- Input dedicado para escaneo web (lector de c√≥digo de barras) -->
    <div class="web-scanner-section hidden" id="webScannerSection">
      <div class="web-scanner-title">Escanear con lector</div>
      <input type="text" id="webScannerInput" class="web-scanner-input" placeholder="Esperando escaneo..." autocomplete="off">
      <div class="web-scanner-hint">El lector escribir√° aqu√≠ autom√°ticamente</div>
      <div class="web-scanner-status ready" id="webScannerStatus">‚úì Listo para escanear</div>
    </div>

    <!-- Lista desplegable de items escaneados -->
    <div class="scanned-dropdown hidden" id="scannedDropdown">
      <div class="scanned-dropdown-header" id="scannedDropdownHeader">
        <h3>
          <span>Items escaneados</span>
          <span class="scanned-dropdown-badge" id="scannedBadge">0/0</span>
        </h3>
        <span class="scanned-dropdown-toggle">‚ñº</span>
      </div>
      <div class="scanned-dropdown-list" id="scannedList"></div>
    </div>

    <div class="items-section hidden" id="itemsSection">
      <div class="items-header">
        <h2>Productos a verificar</h2>
        <div class="items-meta">
          <span class="items-cuenta" id="itemsCuenta">-</span>
          <span id="itemsProducto"></span>
        </div>
        <span class="items-count" id="itemsCount">0/0</span>
      </div>
      <div id="itemsList"></div>
      <div id="visionResult" class="vision-result hidden"></div>
    </div>

    <button type="button" class="reset-btn hidden" id="resetBtn">Nuevo codigo</button>
    </div><!-- fin sectionSeguimiento -->
  </div>

  <div class="complete-banner" id="completeBanner">‚úì Verificacion completa</div>
  <button type="button" id="cameraBtn" class="camera-btn">Escanear codigo</button>

  <!-- Toast para feedback r√°pido en web -->
  <div class="scan-toast" id="scanToast">
    <div id="scanToastMessage">Verificado</div>
    <div class="scan-toast-code" id="scanToastCode"></div>
    <div class="scan-toast-count" id="scanToastCount"></div>
  </div>

  <!-- Panel de verificaci√≥n de producto (web) -->
  <div class="verify-panel hidden" id="verifyPanel">
    <div class="verify-panel-header">
      <div class="verify-panel-code" id="verifyPanelCode">CODIGO</div>
      <div class="verify-panel-title" id="verifyPanelTitle">Nombre del producto</div>
      <div class="verify-panel-sku" id="verifyPanelSku">SKU</div>
      <button class="verify-panel-delete" id="verifyPanelDelete" onclick="borrarVerificacion()">BORRAR</button>
    </div>
    <div class="verify-panel-body">
      <div class="verify-panel-instruction">
        <strong>Verific√° que el producto coincida</strong><br>
        Escane√° de nuevo para confirmar cada item
      </div>
      <div class="verify-panel-items" id="verifyPanelItems"></div>
    </div>
    <div class="verify-panel-footer">
      <div class="verify-panel-progress">
        <div class="verify-panel-progress-bar">
          <div class="verify-panel-progress-fill" id="verifyPanelProgressFill" style="width: 0%"></div>
        </div>
        <div class="verify-panel-progress-text" id="verifyPanelProgressText">0/0</div>
      </div>
    </div>
  </div>

  <style>
    .camera-btn.hidden { display: none; }
    .scan-section.hidden { display: none; }
    .toggle-upload-btn.hidden { display: none; }
  </style>

  <!-- Vision Camera Modal para verificaci√≥n con IA -->
  <div class="vision-camera-modal hidden" id="visionCameraModal">
    <div class="vision-camera-header">
      <h3>Verificar con IA</h3>
      <button type="button" class="vision-camera-close" id="visionCameraClose">‚úï</button>
    </div>
    <div class="vision-camera-body">
      <video id="visionVideo" playsinline autoplay></video>
      <div class="vision-product-info" id="visionProductInfo">
        <strong>Producto:</strong> <span id="visionProductName">-</span>
      </div>
    </div>
    <div class="vision-camera-footer">
      <button type="button" class="vision-analyze-btn" id="visionAnalyzeBtn">
        <span>üîç</span> Analizar
      </button>
    </div>
  </div>

  <!-- Canvas oculto para captura -->
  <canvas id="visionCanvas" style="display:none"></canvas>

  <!-- Modal de detalle de colecta -->
  <div class="colecta-modal hidden" id="colectaModal">
    <div class="colecta-modal-content">
      <div class="colecta-modal-header">
        <h3 id="modalColectaNombre">Colecta</h3>
        <button type="button" class="colecta-modal-close" id="modalClose">‚úï</button>
      </div>
      <div class="colecta-modal-info" id="modalColectaInfo"></div>
      <div class="colecta-modal-progress">
        <div class="colecta-modal-progress-bar">
          <div class="colecta-modal-progress-fill" id="modalProgressFill"></div>
        </div>
        <div class="colecta-modal-progress-text" id="modalProgressText"></div>
      </div>
      <div class="colecta-modal-items" id="modalColectaItems"></div>
    </div>
  </div>

  <script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    // ============================================
    // AUTENTICACI√ìN
    // ============================================
    (function authInit() {
      var loginOverlay = document.getElementById('loginOverlay');
      var loginForm = document.getElementById('loginForm');
      var loginUser = document.getElementById('loginUser');
      var loginPassword = document.getElementById('loginPassword');
      var loginError = document.getElementById('loginError');
      var loginBtn = document.getElementById('loginBtn');
      var logoutBtn = document.getElementById('logoutBtn');

      function checkAuth() {
        return fetch('/api/auth/check', { credentials: 'include' })
          .then(function(res) { return res.json(); })
          .then(function(data) {
            if (data.authenticated) {
              showApp();
              return true;
            } else {
              showLogin();
              return false;
            }
          })
          .catch(function() {
            showLogin();
            return false;
          });
      }

      function showLogin() {
        loginOverlay.classList.remove('hidden');
        logoutBtn.classList.add('hidden');
        loginUser.focus();
      }

      function showApp() {
        loginOverlay.classList.add('hidden');
        logoutBtn.classList.remove('hidden');
        if (typeof initMainApp === 'function') {
          initMainApp();
        }
      }

      loginForm.onsubmit = function(e) {
        e.preventDefault();
        loginError.classList.remove('show');
        loginBtn.disabled = true;
        loginBtn.textContent = 'Ingresando...';

        fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            username: loginUser.value,
            password: loginPassword.value
          })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          loginBtn.disabled = false;
          loginBtn.textContent = 'Iniciar Sesion';
          if (data.success) {
            loginPassword.value = '';
            showApp();
          } else {
            loginError.textContent = data.error || 'Error al iniciar sesion';
            loginError.classList.add('show');
          }
        })
        .catch(function(err) {
          loginBtn.disabled = false;
          loginBtn.textContent = 'Iniciar Sesion';
          loginError.textContent = 'Error de conexion';
          loginError.classList.add('show');
        });
      };

      logoutBtn.onclick = function() {
        fetch('/api/auth/logout', { method: 'POST', credentials: 'include' })
        .then(function() { showLogin(); })
        .catch(function() { showLogin(); });
      };

      checkAuth();
    })();

    // ============================================
    // APP PRINCIPAL
    // ============================================
    var mainAppInitialized = false;
    function initMainApp() {
      if (mainAppInitialized) return;
      mainAppInitialized = true;

      var currentItems = [];
      var unitChecks = {};
      var codeReader = null;
      var isScanning = false;
      var currentCodigo = null;
      var photoItemIndex = null;

      var codigoInput = document.getElementById('codigoInput');
      var searchBtn = document.getElementById('searchBtn');
      var cameraBtn = document.getElementById('cameraBtn');
      var cameraContainer = document.getElementById('cameraContainer');
      var closeCameraBtn = document.getElementById('closeCamera');
      var video = document.getElementById('video');
      var statusMessage = document.getElementById('statusMessage');
      var itemsSection = document.getElementById('itemsSection');
      var itemsList = document.getElementById('itemsList');
      var itemsCount = document.getElementById('itemsCount');
      var itemsCuenta = document.getElementById('itemsCuenta');
      var itemsProducto = document.getElementById('itemsProducto');
      var completeBanner = document.getElementById('completeBanner');
      var resetBtn = document.getElementById('resetBtn');
      var statsBadge = document.getElementById('statsBadge');
      var visionResult = document.getElementById('visionResult');

      // Vision camera elements
      var visionCameraModal = document.getElementById('visionCameraModal');
      var visionCameraClose = document.getElementById('visionCameraClose');
      var visionVideo = document.getElementById('visionVideo');
      var visionAnalyzeBtn = document.getElementById('visionAnalyzeBtn');
      var visionProductInfo = document.getElementById('visionProductInfo');
      var visionProductName = document.getElementById('visionProductName');
      var visionCanvas = document.getElementById('visionCanvas');
      var visionStream = null;

      // Scanned items dropdown elements
      var scannedDropdown = document.getElementById('scannedDropdown');
      var scannedDropdownHeader = document.getElementById('scannedDropdownHeader');
      var scannedBadge = document.getElementById('scannedBadge');
      var scannedList = document.getElementById('scannedList');
      var scannedItems = {}; // { codigoML: { cantidad, cantidadVerificada, descripcion } }

      // Toast elements (web con lector)
      var scanToast = document.getElementById('scanToast');
      var scanToastMessage = document.getElementById('scanToastMessage');
      var scanToastCode = document.getElementById('scanToastCode');
      var scanToastCount = document.getElementById('scanToastCount');
      var lastVerifiedCode = null; // Para confirmaci√≥n con segundo escaneo
      var toastTimeout = null;

      // Web scanner elements (input dedicado para lector)
      var webScannerSection = document.getElementById('webScannerSection');
      var webScannerInput = document.getElementById('webScannerInput');
      var webScannerStatus = document.getElementById('webScannerStatus');

      // Panel de verificaci√≥n de producto (web)
      var verifyPanel = document.getElementById('verifyPanel');
      var verifyPanelCode = document.getElementById('verifyPanelCode');
      var verifyPanelTitle = document.getElementById('verifyPanelTitle');
      var verifyPanelSku = document.getElementById('verifyPanelSku');
      var verifyPanelItems = document.getElementById('verifyPanelItems');
      var verifyPanelProgressFill = document.getElementById('verifyPanelProgressFill');
      var verifyPanelProgressText = document.getElementById('verifyPanelProgressText');
      var currentVerifyCode = null; // C√≥digo actual en el panel
      var currentVerifyItems = []; // Items del producto actual
      var confirmedCount = 0; // Cantidad de items confirmados

      // ============================================
      // MAIN TABS (solo web, no PWA)
      // ============================================
      var mainTabs = document.getElementById('mainTabs');
      var mainHeader = document.getElementById('mainHeader');
      var sectionCreacion = document.getElementById('sectionCreacion');
      var sectionSeguimiento = document.getElementById('sectionSeguimiento');

      // Detectar PWA
      var isPWA = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
      var activeMainSection = 'seguimiento'; // 'creacion' o 'seguimiento'

      // ============================================
      // CELEBRACI√ìN DE COLECTA COMPLETADA
      // ============================================
      var celebrationOverlay = document.getElementById('celebrationOverlay');
      var celebrationText = document.getElementById('celebrationText');
      var celebrationSubtext = document.getElementById('celebrationSubtext');
      var confettiContainer = document.getElementById('confettiContainer');
      var celebratedColectas = {}; // Registro de colectas ya celebradas (solo una vez por colecta)

      // ============================================
      // ALERTA DE TODAS LAS UNIDADES ESCANEADAS
      // ============================================
      var allScannedOverlay = document.getElementById('allScannedOverlay');
      var allScannedSubtext = document.getElementById('allScannedSubtext');

      function showAllScannedAlert(codigo, cantidad) {
        allScannedSubtext.textContent = codigo + ' (' + cantidad + '/' + cantidad + ' unidades)';
        allScannedOverlay.classList.add('show');

        // Vibraci√≥n de alerta
        if (navigator.vibrate) {
          navigator.vibrate([300, 100, 300]);
        }

        // Cerrar autom√°ticamente despu√©s de 2.5 segundos
        setTimeout(function() {
          hideAllScannedAlert();
        }, 2500);
      }

      function hideAllScannedAlert() {
        allScannedOverlay.classList.remove('show');
      }

      // Cerrar alerta al hacer click
      allScannedOverlay.onclick = function() {
        hideAllScannedAlert();
      };

      function createConfetti() {
        var colors = ['#22c55e', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6'];
        var confettiCount = 150;

        confettiContainer.innerHTML = '';

        for (var i = 0; i < confettiCount; i++) {
          var confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = Math.random() * 100 + '%';
          confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.width = (Math.random() * 10 + 5) + 'px';
          confetti.style.height = (Math.random() * 10 + 5) + 'px';
          confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
          confetti.style.animation = 'confettiFall ' + (Math.random() * 2 + 2) + 's linear forwards';
          confetti.style.animationDelay = Math.random() * 0.5 + 's';
          confettiContainer.appendChild(confetti);
        }
      }

      function showCelebration(colectaNombre) {
        celebrationSubtext.textContent = colectaNombre || '';
        celebrationOverlay.classList.add('show');
        createConfetti();

        // Vibraci√≥n de celebraci√≥n
        if (navigator.vibrate) {
          navigator.vibrate([200, 100, 200, 100, 400]);
        }

        // Cerrar autom√°ticamente despu√©s de 4 segundos
        setTimeout(function() {
          hideCelebration();
        }, 4000);
      }

      function hideCelebration() {
        celebrationOverlay.classList.remove('show');
        setTimeout(function() {
          confettiContainer.innerHTML = '';
        }, 500);
      }

      // Cerrar celebraci√≥n al hacer click
      celebrationOverlay.onclick = function() {
        hideCelebration();
      };

      if (!isPWA) {
        // Mostrar tabs solo en web
        mainTabs.classList.add('show');
        mainHeader.classList.add('with-tabs');

        // Event listeners para main tabs
        document.querySelectorAll('.main-tab').forEach(function(tab) {
          tab.onclick = function() {
            document.querySelectorAll('.main-tab').forEach(function(t) { t.classList.remove('active'); });
            this.classList.add('active');
            var section = this.getAttribute('data-section');
            activeMainSection = section;

            // Ocultar todas las secciones
            sectionCreacion.classList.remove('active');
            sectionSeguimiento.classList.remove('active');

            // Mostrar la secci√≥n seleccionada
            if (section === 'creacion') {
              sectionCreacion.classList.add('active');
              // Ocultar bot√≥n c√°mara y banner en secci√≥n creaci√≥n
              cameraBtn.classList.add('hidden');
              completeBanner.classList.remove('show');
            } else {
              sectionSeguimiento.classList.add('active');
              // Mostrar bot√≥n c√°mara si estamos en pesta√±a verificar
              if (typeof currentView !== 'undefined' && currentView === 'verificar') {
                cameraBtn.classList.remove('hidden');
              }
            }
          };
        });
      } else {
        // En PWA: ocultar secci√≥n creaci√≥n, mostrar solo seguimiento
        sectionCreacion.style.display = 'none';
        sectionSeguimiento.classList.add('active');
      }

      // En web: mostrar pesta√±a Lista activa por defecto, pero mantener Verificar visible
      var tabVerificar = document.getElementById('tabVerificar');
      var tabLista = document.getElementById('tabLista');
      if (!isPWA && tabVerificar && tabLista) {
        // Poner Lista como activa por defecto en web
        tabVerificar.classList.remove('active');
        tabLista.classList.add('active');
      }

      // ============================================
      // COLECTAS (m√∫ltiples)
      // ============================================
      var colectasLista = document.getElementById('colectasLista');
      var colectasCalendario = document.getElementById('colectasCalendario');
      var colectasCount = document.getElementById('colectasCount');
      var colectaUpload = document.getElementById('colectaUpload');
      var colectaForm = document.getElementById('colectaForm');
      var colectaFechaInput = document.getElementById('colectaFechaInput');
      var colectaCuentaInput = document.getElementById('colectaCuentaInput');
      var colectaPdfInput = document.getElementById('colectaPdfInput');
      var colectaUploadBtn = document.getElementById('colectaUploadBtn');
      var toggleUploadBtn = document.getElementById('toggleUploadBtn');

      var colectasData = [];
      var currentView = isPWA ? 'verificar' : 'lista';

      function loadColectas() {
        fetch('/api/colectas', { credentials: 'include' })
          .then(function(res) { return res.json(); })
          .then(function(data) {
            colectasData = data.colectas || [];
            colectasCount.textContent = data.total;
            renderColectas();
            // Recargar items si hay colecta activa
            if (colectaActivaId) {
              cargarItemsColectaActiva();
              // Verificar si la colecta activa lleg√≥ al 100% por primera vez
              var colectaActiva = colectasData.find(function(c) { return c.id === colectaActivaId; });
              if (colectaActiva && colectaActiva.progreso === 100 && !celebratedColectas[colectaActivaId]) {
                // Colecta lleg√≥ al 100% por primera vez, celebrar!
                celebratedColectas[colectaActivaId] = true;
                var nombreColecta = colectaActiva.cuenta || colectaActiva.nombre || '';
                showCelebration(nombreColecta);
              }
            }
          })
          .catch(function(err) {
            console.error('Error cargando colectas:', err);
          });
      }
      loadColectas();

      var colectasVerificar = document.getElementById('colectasVerificar');
      var colectaActivaSelect = document.getElementById('colectaActivaSelect');
      var verificarColectaInfo = document.getElementById('verificarColectaInfo');
      var colectaActivaId = null;

      function renderColectas() {
        // Ocultar todas las vistas
        colectasLista.classList.add('hidden');
        colectasCalendario.classList.add('hidden');
        colectasVerificar.classList.add('hidden');

        // Mostrar/ocultar secciones de escaneo seg√∫n contexto
        var scanSection = document.querySelector('.scan-section');
        if (currentView === 'verificar' && activeMainSection === 'seguimiento') {
          if (isPWA) {
            // PWA: mostrar buscador con c√°mara
            scanSection.classList.remove('hidden');
            cameraBtn.classList.remove('hidden');
            webScannerSection.classList.add('hidden');
          } else {
            // Web: ocultar buscador, mostrar input dedicado para lector
            scanSection.classList.add('hidden');
            cameraBtn.classList.add('hidden');
            webScannerSection.classList.remove('hidden');
            actualizarEstadoWebScanner();
            // Auto-foco en el input del lector
            setTimeout(function() { webScannerInput.focus(); }, 100);
          }
        } else {
          cameraBtn.classList.add('hidden');
          scanSection.classList.add('hidden');
          webScannerSection.classList.add('hidden');
          // Ocultar tambi√©n resultados si cambiamos de pesta√±a
          itemsSection.classList.add('hidden');
          resetBtn.classList.add('hidden');
          completeBanner.classList.remove('show');
        }

        // Mostrar/ocultar bot√≥n Nueva Colecta
        if (currentView === 'verificar') {
          toggleUploadBtn.classList.add('hidden');
          colectaUpload.classList.add('hidden');
        } else {
          toggleUploadBtn.classList.remove('hidden');
        }

        if (currentView === 'lista') {
          renderListaColectas();
          colectasLista.classList.remove('hidden');
        } else if (currentView === 'calendario') {
          renderCalendarioColectas();
          colectasCalendario.classList.remove('hidden');
        } else if (currentView === 'verificar') {
          renderVerificarColectas();
          colectasVerificar.classList.remove('hidden');
        }
      }

      function actualizarEstadoWebScanner() {
        if (colectaActivaId) {
          var col = colectasData.find(function(c) { return c.id === colectaActivaId; });
          var nombre = col ? (col.cuenta || col.nombre) : '';
          webScannerStatus.className = 'web-scanner-status ready';
          webScannerStatus.textContent = '‚úì Listo - ' + nombre;
          webScannerInput.disabled = false;
          webScannerInput.placeholder = 'Esperando escaneo...';
        } else {
          webScannerStatus.className = 'web-scanner-status no-colecta';
          webScannerStatus.textContent = '‚ö† Seleccion√° una colecta primero';
          webScannerInput.disabled = true;
          webScannerInput.placeholder = 'Seleccion√° una colecta...';
        }
      }

      function renderVerificarColectas() {
        // Llenar el selector con las colectas
        var html = '<option value="">-- Elegir colecta --</option>';
        colectasData.forEach(function(col) {
          var estado = col.progreso === 100 ? '‚úì' : col.progreso + '%';
          var selected = col.id === colectaActivaId ? ' selected' : '';
          html += '<option value="' + col.id + '"' + selected + '>';
          html += (col.cuenta || 'Sin cuenta') + ' - ' + formatearFecha(col.fechaColecta) + ' (' + estado + ')';
          html += '</option>';
        });
        colectaActivaSelect.innerHTML = html;

        // Mostrar info de colecta seleccionada
        if (colectaActivaId) {
          mostrarInfoColectaActiva();
        } else {
          verificarColectaInfo.classList.add('hidden');
        }
      }

      function mostrarInfoColectaActiva() {
        var col = colectasData.find(function(c) { return c.id === colectaActivaId; });
        if (!col) {
          verificarColectaInfo.classList.add('hidden');
          return;
        }

        var isComplete = col.progreso === 100;
        var estadoClass = isComplete ? 'complete' : 'pending';
        var estadoTexto = isComplete ? '‚úì Terminada' : '‚è≥ En proceso';

        var html = '<div class="verificar-colecta-header">';
        html += '<div>';
        html += '<div class="verificar-colecta-cuenta">' + (col.cuenta || 'Sin cuenta') + '</div>';
        html += '<div class="verificar-colecta-fecha">' + formatearFecha(col.fechaColecta) + ' - ' + col.nombre + '</div>';
        html += '</div>';
        html += '<span class="verificar-colecta-estado ' + estadoClass + '">' + estadoTexto + '</span>';
        html += '</div>';

        html += '<div class="verificar-progress">';
        html += '<div class="verificar-progress-bar"><div class="verificar-progress-fill" style="width:' + col.progreso + '%"></div></div>';
        html += '<div class="verificar-progress-text">' + (col.unidadesVerificadas || 0) + ' / ' + col.totalUnidades + ' unidades</div>';
        html += '</div>';

        if (!isComplete) {
          html += '<div class="verificar-mensaje">Escane√° o ingres√° un c√≥digo ML para verificar</div>';
        } else {
          html += '<div class="verificar-mensaje" style="color:#16a34a">¬°Colecta completada!</div>';
        }

        verificarColectaInfo.innerHTML = html;
        verificarColectaInfo.classList.remove('hidden');
      }

      colectaActivaSelect.addEventListener('change', function() {
        colectaActivaId = this.value || null;
        // Si la colecta seleccionada ya est√° al 100%, marcarla como celebrada para no celebrar al seleccionar
        var colectaSeleccionada = colectasData.find(function(c) { return c.id === colectaActivaId; });
        if (colectaSeleccionada && colectaSeleccionada.progreso === 100) {
          celebratedColectas[colectaActivaId] = true;
        }
        mostrarInfoColectaActiva();
        // Limpiar b√∫squeda anterior
        itemsSection.classList.add('hidden');
        resetBtn.classList.add('hidden');
        completeBanner.classList.remove('show');
        codigoInput.value = '';
        // Cargar items de la colecta activa
        cargarItemsColectaActiva();
        // Actualizar estado del scanner web
        if (!isPWA) {
          actualizarEstadoWebScanner();
          webScannerInput.value = '';
          setTimeout(function() { webScannerInput.focus(); }, 100);
        }
      });

      // Event listener para el input del lector web
      webScannerInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          verificarCodigoWeb(webScannerInput.value);
        }
      });

      // ============================================
      // LISTA DESPLEGABLE DE ITEMS ESCANEADOS
      // ============================================
      scannedDropdownHeader.onclick = function() {
        scannedDropdown.classList.toggle('open');
      };

      function cargarItemsColectaActiva() {
        if (!colectaActivaId) {
          scannedDropdown.classList.add('hidden');
          scannedItems = {};
          return;
        }

        fetch('/api/colecta/' + colectaActivaId, { credentials: 'include' })
          .then(function(res) { return res.json(); })
          .then(function(data) {
            scannedItems = {};
            if (data.items && data.items.length > 0) {
              data.items.forEach(function(item) {
                scannedItems[item.codigoML] = {
                  cantidad: item.cantidad,
                  cantidadVerificada: item.cantidadVerificada || 0,
                  descripcion: item.descripcion || item.sku || item.codigoML
                };
              });
            }
            actualizarListaEscaneados();
          })
          .catch(function(err) {
            console.error('Error cargando items de colecta:', err);
          });
      }

      function actualizarListaEscaneados() {
        var codigos = Object.keys(scannedItems);
        if (codigos.length === 0) {
          scannedDropdown.classList.add('hidden');
          return;
        }

        scannedDropdown.classList.remove('hidden');
        scannedDropdown.classList.add('open'); // Siempre expandida

        var totalItems = codigos.length;
        var completados = 0;
        var html = '';

        codigos.forEach(function(codigo) {
          var item = scannedItems[codigo];
          var esCompleto = item.cantidadVerificada >= item.cantidad;
          var esParcial = item.cantidadVerificada > 0 && !esCompleto;
          if (esCompleto) completados++;

          var statusClass = esCompleto ? 'complete' : (esParcial ? 'partial' : 'pending');
          var tieneVerificacion = item.cantidadVerificada > 0;
          var puedeAgregar = item.cantidadVerificada < item.cantidad;

          html += '<div class="scanned-item">';
          html += '<div class="scanned-item-info">';
          html += '<div class="scanned-item-code">' + codigo + '</div>';
          html += '<div class="scanned-item-desc">' + item.descripcion + '</div>';
          html += '</div>';
          html += '<div class="scanned-item-actions">';
          html += '<button class="scanned-item-btn minus" onclick="window.decrementarItem(\'' + codigo + '\')"' + (!tieneVerificacion ? ' disabled' : '') + '>-</button>';
          html += '<span class="scanned-item-count ' + statusClass + '">' + item.cantidadVerificada + '/' + item.cantidad + '</span>';
          html += '<button class="scanned-item-btn plus" onclick="window.incrementarItem(\'' + codigo + '\')"' + (!puedeAgregar ? ' disabled' : '') + '>+</button>';
          html += '</div>';
          html += '</div>';
        });

        scannedList.innerHTML = html;
        scannedBadge.textContent = completados + '/' + totalItems;
        scannedBadge.className = 'scanned-dropdown-badge' + (completados < totalItems ? ' pending' : '');
      }

      // ============================================
      // TOAST Y FLUJO WEB (lector de c√≥digo de barras)
      // ============================================
      function showToast(message, type, code, count) {
        if (toastTimeout) clearTimeout(toastTimeout);

        scanToastMessage.textContent = message;
        scanToastCode.textContent = code || '';
        scanToastCount.textContent = count || '';
        scanToast.className = 'scan-toast show' + (type ? ' ' + type : '');

        toastTimeout = setTimeout(function() {
          scanToast.classList.remove('show');
        }, 1500);
      }

      var webScannerBusy = false; // Prevenir escaneos mientras se procesa

      function verificarCodigoWeb(codigo) {
        if (!codigo || codigo.trim() === '') return;

        // Limpiar input INMEDIATAMENTE para el pr√≥ximo escaneo
        webScannerInput.value = '';

        if (!colectaActivaId) {
          showToast('Eleg√≠ una colecta', 'error');
          webScannerInput.focus();
          return;
        }

        codigo = codigo.trim().toUpperCase();

        // Si hay panel abierto con el mismo c√≥digo: confirmar siguiente item
        if (currentVerifyCode === codigo) {
          confirmarSiguienteItem();
          webScannerInput.focus();
          return;
        }

        // Si hay panel abierto con otro c√≥digo: cerrarlo primero
        if (currentVerifyCode && currentVerifyCode !== codigo) {
          cerrarPanelVerificacion();
        }

        // Verificar primero si el c√≥digo est√° en la colecta
        var itemEnColecta = scannedItems[codigo];
        if (!itemEnColecta) {
          showToast('NO EN COLECTA', 'error', codigo);
          webScannerInput.focus();
          return;
        }

        // Verificar si ya tiene todas las unidades escaneadas
        if (itemEnColecta.cantidad > 0 && itemEnColecta.cantidadVerificada >= itemEnColecta.cantidad) {
          showAllScannedAlert(codigo, itemEnColecta.cantidad);
          webScannerInput.focus();
          return;
        }

        // Prevenir doble procesamiento
        if (webScannerBusy) return;
        webScannerBusy = true;

        // Buscar informaci√≥n detallada del producto
        fetch('/api/codigo/' + encodeURIComponent(codigo), { credentials: 'include' })
          .then(function(res) { return res.json(); })
          .then(function(data) {
            if (data.error) {
              // Si no est√° en el cache general, usar datos de la colecta
              mostrarPanelVerificacion(codigo, {
                producto: itemEnColecta.descripcion,
                items: [{ sku: codigo, description: itemEnColecta.descripcion, quantity: itemEnColecta.cantidad }]
              });
              return;
            }
            // Mostrar panel de verificaci√≥n con datos completos
            mostrarPanelVerificacion(codigo, data);
          })
          .catch(function(err) {
            // Fallback a datos de colecta
            mostrarPanelVerificacion(codigo, {
              producto: itemEnColecta.descripcion,
              items: [{ sku: codigo, description: itemEnColecta.descripcion, quantity: itemEnColecta.cantidad }]
            });
          })
          .finally(function() {
            webScannerBusy = false;
            webScannerInput.focus();
          });
      }

      function mostrarPanelVerificacion(codigo, data) {
        currentVerifyCode = codigo;
        currentVerifyItems = data.items || [];
        confirmedCount = 0;

        // Llenar header
        verifyPanelCode.textContent = codigo;
        verifyPanelTitle.textContent = data.producto || 'Producto';
        verifyPanelSku.textContent = data.items && data.items[0] ? 'SKU: ' + data.items[0].sku : '';

        // Generar items
        var html = '';
        currentVerifyItems.forEach(function(item, index) {
          var isCurrent = index === 0;
          html += '<div class="verify-panel-item' + (isCurrent ? ' current' : '') + '" data-index="' + index + '">';
          html += '<div class="verify-panel-item-check"></div>';
          html += '<div class="verify-panel-item-info">';
          html += '<div class="verify-panel-item-name">' + (item.description || item.sku) + '</div>';
          html += '<div class="verify-panel-item-detail">SKU: ' + item.sku + '</div>';
          html += '</div>';
          html += '<div class="verify-panel-item-qty">x' + item.quantity + '</div>';
          html += '</div>';
        });
        verifyPanelItems.innerHTML = html;

        // Actualizar progreso
        actualizarProgresoPanel();

        // Mostrar panel
        verifyPanel.classList.remove('hidden');
      }

      function confirmarSiguienteItem() {
        if (confirmedCount >= currentVerifyItems.length) {
          // Ya todo confirmado, cerrar
          cerrarPanelVerificacion();
          return;
        }

        // Marcar item actual como confirmado
        var items = verifyPanelItems.querySelectorAll('.verify-panel-item');
        if (items[confirmedCount]) {
          items[confirmedCount].classList.remove('current');
          items[confirmedCount].classList.add('confirmed');
          items[confirmedCount].querySelector('.verify-panel-item-check').textContent = '‚úì';
        }

        confirmedCount++;

        // Marcar siguiente como current
        if (confirmedCount < currentVerifyItems.length) {
          if (items[confirmedCount]) {
            items[confirmedCount].classList.add('current');
          }
          actualizarProgresoPanel();
          showToast('‚úì ITEM ' + confirmedCount, '', '', confirmedCount + '/' + currentVerifyItems.length);
        } else {
          // Kit completo! Solo ahora verificamos en el servidor (1 vez por kit completo)
          fetch('/api/colecta/' + colectaActivaId + '/verificar/' + encodeURIComponent(currentVerifyCode), {
            method: 'POST',
            credentials: 'include'
          }).then(function() {
            loadColectas();
            cargarItemsColectaActiva();
          });

          actualizarProgresoPanel();
          showToast('‚úì COMPLETO', '', currentVerifyCode);
          // Cerrar panel despu√©s de 1.5 segundos
          setTimeout(function() {
            cerrarPanelVerificacion();
          }, 1500);
        }
      }

      function actualizarProgresoPanel() {
        var total = currentVerifyItems.length;
        var porcentaje = total > 0 ? Math.round((confirmedCount / total) * 100) : 0;
        verifyPanelProgressFill.style.width = porcentaje + '%';
        verifyPanelProgressText.textContent = confirmedCount + '/' + total;
      }

      function cerrarPanelVerificacion() {
        verifyPanel.classList.add('hidden');
        currentVerifyCode = null;
        currentVerifyItems = [];
        confirmedCount = 0;
        webScannerInput.focus();
      }

      function borrarVerificacion() {
        if (!currentVerifyCode || !colectaActivaId) {
          cerrarPanelVerificacion();
          return;
        }

        // Llamar al endpoint de desverificar
        fetch('/api/colecta/' + colectaActivaId + '/desverificar/' + encodeURIComponent(currentVerifyCode), {
          method: 'POST',
          credentials: 'include'
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (data.success) {
            showToast('BORRADO', 'error', currentVerifyCode);
            loadColectas();
            cargarItemsColectaActiva();
          }
        })
        .catch(function(err) {
          showToast('ERROR', 'error', 'No se pudo borrar');
        })
        .finally(function() {
          cerrarPanelVerificacion();
        });
      }

      // Funciones globales para +/- en lista de items
      window.decrementarItem = function(codigo) {
        if (!codigo || !colectaActivaId) return;

        fetch('/api/colecta/' + colectaActivaId + '/decrementar/' + encodeURIComponent(codigo), {
          method: 'POST',
          credentials: 'include'
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (data.success) {
            showToast('-1', 'error', codigo);
            loadColectas();
            cargarItemsColectaActiva();
          }
        })
        .catch(function(err) {
          showToast('ERROR', 'error', 'No se pudo decrementar');
        });
      };

      window.incrementarItem = function(codigo) {
        if (!codigo || !colectaActivaId) return;

        fetch('/api/colecta/' + colectaActivaId + '/verificar/' + encodeURIComponent(codigo), {
          method: 'POST',
          credentials: 'include'
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (data.success) {
            showToast('+1', '', codigo);
            loadColectas();
            cargarItemsColectaActiva();
          }
        })
        .catch(function(err) {
          showToast('ERROR', 'error', 'No se pudo incrementar');
        });
      };

      function renderListaColectas() {
        if (colectasData.length === 0) {
          colectasLista.innerHTML = '<div class="empty-state"><p>No hay colectas activas</p></div>';
          return;
        }

        var html = '';
        colectasData.forEach(function(col) {
          html += '<div class="colecta-item" data-id="' + col.id + '">';
          html += '<div class="colecta-item-header">';
          html += '<div class="colecta-item-principal">';
          if (col.cuenta) html += '<span class="colecta-item-cuenta-grande">' + col.cuenta + '</span>';
          html += '<span class="colecta-item-fecha-grande">' + formatearFecha(col.fechaColecta) + '</span>';
          html += '</div>';
          html += '<span class="colecta-item-envio">' + col.nombre + '</span>';
          html += '</div>';
          html += '<div class="colecta-item-progress"><div class="colecta-item-progress-bar" style="width:' + col.progreso + '%"></div></div>';
          html += '<div class="colecta-item-stats">';
          html += '<span>' + (col.unidadesVerificadas || 0) + '/' + col.totalUnidades + ' unidades (' + col.progreso + '%)</span>';
          html += '</div>';
          html += '<div class="colecta-item-actions">';
          html += '<button class="colecta-item-btn delete" onclick="eliminarColecta(\'' + col.id + '\')">Eliminar</button>';
          html += '</div>';
          html += '</div>';
        });
        colectasLista.innerHTML = html;
      }

      var calendarioMesActual = new Date();
      var calendarioColectasPorFecha = {};
      var calendarioFechaSeleccionada = null;

      function renderCalendarioColectas() {
        fetch('/api/colectas/calendario', { credentials: 'include' })
          .then(function(res) { return res.json(); })
          .then(function(porFecha) {
            calendarioColectasPorFecha = porFecha;
            renderCalendarioMes();
          });
      }

      function renderCalendarioMes() {
        var year = calendarioMesActual.getFullYear();
        var month = calendarioMesActual.getMonth();
        var hoy = new Date();

        var meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        var diasSemana = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];

        var html = '';

        // Navegaci√≥n
        html += '<div class="calendar-nav">';
        html += '<button class="calendar-nav-btn" onclick="cambiarMesCalendario(-1)">‚óÄ</button>';
        html += '<span class="calendar-month">' + meses[month] + ' ' + year + '</span>';
        html += '<button class="calendar-nav-btn" onclick="cambiarMesCalendario(1)">‚ñ∂</button>';
        html += '</div>';

        // Grilla
        html += '<div class="calendar-grid">';

        // D√≠as de la semana
        diasSemana.forEach(function(dia) {
          html += '<div class="calendar-weekday">' + dia + '</div>';
        });

        // Primer d√≠a del mes y cantidad de d√≠as
        var primerDia = new Date(year, month, 1);
        var ultimoDia = new Date(year, month + 1, 0);
        var diasEnMes = ultimoDia.getDate();
        var primerDiaSemana = primerDia.getDay();

        // D√≠as del mes anterior
        var diasMesAnterior = new Date(year, month, 0).getDate();
        for (var i = primerDiaSemana - 1; i >= 0; i--) {
          html += '<div class="calendar-cell other-month"><span class="calendar-cell-day">' + (diasMesAnterior - i) + '</span></div>';
        }

        // D√≠as del mes actual
        for (var dia = 1; dia <= diasEnMes; dia++) {
          var fechaStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(dia).padStart(2, '0');
          var colectasDelDia = calendarioColectasPorFecha[fechaStr] || [];
          var esHoy = hoy.getFullYear() === year && hoy.getMonth() === month && hoy.getDate() === dia;
          var tieneColectas = colectasDelDia.length > 0;

          var clases = 'calendar-cell';
          if (esHoy) clases += ' today';
          if (tieneColectas) clases += ' has-colecta';

          html += '<div class="' + clases + '" onclick="seleccionarDiaCalendario(\'' + fechaStr + '\')">';
          html += '<span class="calendar-cell-day">' + dia + '</span>';

          if (tieneColectas) {
            html += '<div class="calendar-cell-colectas">';
            colectasDelDia.slice(0, 3).forEach(function(col) {
              var estado = col.progreso === 100 ? 'complete' : 'pending';
              var estadoTexto = col.progreso === 100 ? '‚úì' : col.progreso + '%';
              var cuenta = col.cuenta || '?';
              html += '<div class="calendar-cell-colecta ' + estado + '">' + cuenta + ' ' + estadoTexto + '</div>';
            });
            if (colectasDelDia.length > 3) {
              html += '<div class="calendar-cell-colecta pending">+' + (colectasDelDia.length - 3) + ' m√°s</div>';
            }
            html += '</div>';
          }

          html += '</div>';
        }

        // D√≠as del mes siguiente
        var celdasRestantes = 42 - (primerDiaSemana + diasEnMes);
        for (var i = 1; i <= celdasRestantes; i++) {
          html += '<div class="calendar-cell other-month"><span class="calendar-cell-day">' + i + '</span></div>';
        }

        html += '</div>';

        // Detalle del d√≠a seleccionado
        if (calendarioFechaSeleccionada && calendarioColectasPorFecha[calendarioFechaSeleccionada]) {
          var colectas = calendarioColectasPorFecha[calendarioFechaSeleccionada];
          html += '<div class="calendar-day-detail">';
          html += '<div class="calendar-day-detail-header">' + formatearFecha(calendarioFechaSeleccionada) + '</div>';
          html += '<div class="calendar-day-detail-items">';
          colectas.forEach(function(col) {
            var isComplete = col.progreso === 100;
            var estadoTexto = isComplete ? '‚úì Terminada' : '‚è≥ En proceso';
            html += '<div class="calendar-detail-item' + (isComplete ? ' complete' : '') + '" onclick="abrirModalColecta(\'' + col.id + '\')">';
            html += '<div class="calendar-detail-item-header">';
            html += '<span class="calendar-detail-item-cuenta">' + (col.cuenta || 'Sin cuenta') + '</span>';
            html += '<span class="calendar-detail-item-envio">' + estadoTexto + '</span>';
            html += '</div>';
            html += '<div class="calendar-detail-item-stats">' + (col.unidadesVerificadas || 0) + '/' + col.totalUnidades + ' uds (' + col.progreso + '%) - ' + col.nombre + '</div>';
            html += '</div>';
          });
          html += '</div></div>';
        }

        colectasCalendario.innerHTML = html;
      }

      window.cambiarMesCalendario = function(delta) {
        calendarioMesActual.setMonth(calendarioMesActual.getMonth() + delta);
        renderCalendarioMes();
      };

      window.seleccionarDiaCalendario = function(fecha) {
        calendarioFechaSeleccionada = fecha;
        renderCalendarioMes();
      };

      function formatearFecha(fechaStr) {
        var fecha = new Date(fechaStr + 'T00:00:00');
        var dias = ['Dom', 'Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab'];
        var meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
        return dias[fecha.getDay()] + ' ' + fecha.getDate() + ' ' + meses[fecha.getMonth()];
      }

      // Tabs de vista
      document.querySelectorAll('.colectas-tab').forEach(function(tab) {
        tab.onclick = function() {
          document.querySelectorAll('.colectas-tab').forEach(function(t) { t.classList.remove('active'); });
          this.classList.add('active');
          currentView = this.getAttribute('data-view');
          renderColectas();
        };
      });

      // Toggle upload form
      toggleUploadBtn.onclick = function() {
        colectaUpload.classList.toggle('hidden');
        if (!colectaUpload.classList.contains('hidden')) {
          var tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() + 1);
          colectaFechaInput.value = tomorrow.toISOString().split('T')[0];
        }
      };

      // Form submit
      colectaForm.onsubmit = function(e) {
        e.preventDefault();
        var fechaColecta = colectaFechaInput.value;
        var pdfFile = colectaPdfInput.files[0];

        if (!fechaColecta || !pdfFile) {
          showStatus('Completa fecha y PDF', 'error');
          return;
        }

        colectaUploadBtn.disabled = true;
        colectaUploadBtn.textContent = 'Procesando...';
        showStatus('Procesando PDF...', 'loading');

        var formData = new FormData();
        formData.append('fechaColecta', fechaColecta);
        formData.append('pdf', pdfFile);
        if (colectaCuentaInput.value) formData.append('cuenta', colectaCuentaInput.value);

        fetch('/api/colecta/upload', {
          method: 'POST',
          credentials: 'include',
          body: formData
        })
        .then(function(res) { return res.json().then(function(d) { return { ok: res.ok, data: d }; }); })
        .then(function(result) {
          colectaUploadBtn.disabled = false;
          colectaUploadBtn.textContent = 'Cargar colecta';
          if (result.ok) {
            showStatus(result.data.nombre + ': ' + result.data.totalUnidades + ' unidades', 'success');
            colectaPdfInput.value = '';
            colectaCuentaInput.value = '';
            colectaUpload.classList.add('hidden');
            loadColectas();
          } else {
            showStatus(result.data.error || 'Error cargando colecta', 'error');
          }
        })
        .catch(function(err) {
          colectaUploadBtn.disabled = false;
          colectaUploadBtn.textContent = 'Cargar colecta';
          showStatus('Error de conexion', 'error');
        });
      };

      // Eliminar colecta (global function)
      window.eliminarColecta = function(colectaId) {
        if (!confirm('Eliminar esta colecta?')) return;
        fetch('/api/colecta/' + colectaId, { method: 'DELETE', credentials: 'include' })
          .then(function(res) { return res.json(); })
          .then(function(data) {
            if (data.success) {
              showStatus(data.mensaje, 'success');
              loadColectas();
            }
          })
          .catch(function(err) { showStatus('Error eliminando', 'error'); });
      };

      // Modal de detalle de colecta
      var colectaModal = document.getElementById('colectaModal');
      var modalClose = document.getElementById('modalClose');
      var modalColectaNombre = document.getElementById('modalColectaNombre');
      var modalColectaInfo = document.getElementById('modalColectaInfo');
      var modalProgressFill = document.getElementById('modalProgressFill');
      var modalProgressText = document.getElementById('modalProgressText');
      var modalColectaItems = document.getElementById('modalColectaItems');

      // Click en colecta para abrir modal
      colectasLista.addEventListener('click', function(e) {
        var colectaItem = e.target.closest('.colecta-item');
        if (colectaItem && !e.target.closest('.colecta-item-btn')) {
          var colectaId = colectaItem.getAttribute('data-id');
          abrirModalColecta(colectaId);
        }
      });

      // Cerrar modal
      modalClose.onclick = function() {
        colectaModal.classList.add('hidden');
      };
      colectaModal.onclick = function(e) {
        if (e.target === colectaModal) {
          colectaModal.classList.add('hidden');
        }
      };

      function abrirModalColecta(colectaId) {
        fetch('/api/colecta/' + colectaId, { credentials: 'include' })
          .then(function(res) { return res.json(); })
          .then(function(data) {
            if (data.error) {
              showStatus(data.error, 'error');
              return;
            }

            modalColectaNombre.textContent = data.nombre;

            var infoHtml = '<p><strong>Cuenta:</strong> ' + (data.cuenta || 'Sin asignar') + '</p>';
            infoHtml += '<p><strong>Fecha retiro:</strong> ' + data.fechaColecta + '</p>';
            infoHtml += '<p><strong>Productos:</strong> ' + data.totalCodigos + '</p>';
            infoHtml += '<p><strong>Unidades totales:</strong> ' + data.totalUnidades + '</p>';
            modalColectaInfo.innerHTML = infoHtml;

            // Usar datos del backend (ya calculados)
            modalProgressFill.style.width = data.progreso + '%';
            modalProgressText.textContent = data.unidadesVerificadas + '/' + data.totalUnidades + ' unidades verificadas (' + data.progreso + '%)';

            // Renderizar items
            var items = data.items || [];
            var itemsHtml = '';
            items.forEach(function(item) {
              var verificadoClass = item.verificado ? ' verificado' : '';
              var statusIcon = item.verificado ? '‚úÖ' : '‚è≥';
              var nombreProducto = item.descripcion || item.sku || item.codigoML;
              itemsHtml += '<div class="colecta-modal-item' + verificadoClass + '">';
              itemsHtml += '<div class="colecta-modal-item-info">';
              itemsHtml += '<span class="colecta-modal-item-nombre">' + nombreProducto + '</span>';
              itemsHtml += '<span class="colecta-modal-item-codigo">' + item.codigoML + '</span>';
              itemsHtml += '</div>';
              itemsHtml += '<span class="colecta-modal-item-cant">' + item.cantidad + ' uds</span>';
              itemsHtml += '<span class="colecta-modal-item-status">' + statusIcon + '</span>';
              itemsHtml += '</div>';
            });
            modalColectaItems.innerHTML = itemsHtml;

            colectaModal.classList.remove('hidden');
          })
          .catch(function(err) {
            showStatus('Error cargando detalle', 'error');
          });
      }

      // Marcar en la colecta activa seleccionada
      function marcarVerificadoEnColectaActiva(codigoML) {
        if (!colectaActivaId) {
          showStatus('Seleccion√° una colecta primero', 'error');
          return;
        }

        fetch('/api/colecta/' + colectaActivaId + '/verificar/' + encodeURIComponent(codigoML), {
          method: 'POST',
          credentials: 'include'
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (data.success) {
            loadColectas();
            // Actualizar lista de escaneados
            if (scannedItems[codigoML]) {
              scannedItems[codigoML].cantidadVerificada = data.itemVerificado || (scannedItems[codigoML].cantidadVerificada + 1);
              actualizarListaEscaneados();
            } else {
              // Recargar items si no est√° en la lista
              cargarItemsColectaActiva();
            }
            if (data.yaVerificado) {
              showStatus(data.mensaje || 'Este c√≥digo ya estaba verificado', 'loading');
            } else {
              showStatus(data.mensaje || 'Verificado', 'success');
            }
          }
        })
        .catch(function(err) {
          console.error('Error marcando verificado:', err);
        });
      }

      function showStatus(message, type) {
        statusMessage.textContent = message;
        statusMessage.className = 'status-message show ' + type;
        if (type === 'success') {
          setTimeout(hideStatus, 3000);
        }
      }

      function hideStatus() {
        statusMessage.className = 'status-message';
      }

      function isItemComplete(index) {
        var item = currentItems[index];
        var checks = unitChecks[index] || [];
        for (var i = 0; i < item.quantity; i++) {
          var check = checks[i];
          var isChecked = check && (check === true || check.checked === true);
          if (!isChecked) return false;
        }
        return true;
      }

      function countCompletedItems() {
        var count = 0;
        for (var i = 0; i < currentItems.length; i++) {
          if (isItemComplete(i)) count++;
        }
        return count;
      }

      function updateItemsCount() {
        var total = currentItems.length;
        var checked = countCompletedItems();
        itemsCount.textContent = checked + '/' + total;
        if (checked === total && total > 0) {
          completeBanner.classList.add('show');
          if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
          // Marcar en la colecta activa
          if (currentCodigo && currentCodigo.codigoML && colectaActivaId) {
            marcarVerificadoEnColectaActiva(currentCodigo.codigoML);
          }
        } else {
          completeBanner.classList.remove('show');
        }
      }

      function updateCard(index) {
        var card = document.querySelector('.item-card[data-index="' + index + '"]');
        if (!card) return;
        var mainCheckbox = card.querySelector('.item-main-checkbox');
        var complete = isItemComplete(index);
        mainCheckbox.checked = complete;
        card.className = 'item-card' + (complete ? ' checked' : '') + (currentItems[index].isVerificationOnly ? ' verification-only' : '');
        updateItemsCount();
      }

      function highlightCard(index) {
        var card = document.querySelector('.item-card[data-index="' + index + '"]');
        if (!card) return;
        card.classList.add('just-scanned');
        setTimeout(function() {
          card.classList.remove('just-scanned');
        }, 2000);
      }

      function renderItems() {
        itemsList.innerHTML = '';
        for (var i = 0; i < currentItems.length; i++) {
          var item = currentItems[i];
          unitChecks[i] = [];

          var card = document.createElement('div');
          card.className = 'item-card' + (item.isVerificationOnly ? ' verification-only' : '');
          card.setAttribute('data-index', i);
          card.setAttribute('data-sku', item.sku);

          var mainCheckbox = document.createElement('input');
          mainCheckbox.type = 'checkbox';
          mainCheckbox.className = 'item-main-checkbox';
          mainCheckbox.checked = false;

          var info = document.createElement('div');
          info.className = 'item-info';

          var descDiv = document.createElement('div');
          descDiv.className = 'item-description';
          descDiv.textContent = item.description || item.sku;
          if (item.isKit) {
            var badge = document.createElement('span');
            badge.className = 'item-kit-badge';
            badge.textContent = 'KIT';
            descDiv.appendChild(badge);
          }

          var skuDiv = document.createElement('div');
          skuDiv.className = 'item-sku';
          skuDiv.textContent = item.isVerificationOnly ? '‚ö†Ô∏è Verificacion adicional' : 'SKU: ' + item.sku;

          var qtyDiv = document.createElement('div');
          qtyDiv.className = 'item-quantity';
          var displayQty = item.displayQuantity !== undefined ? item.displayQuantity : item.quantity;
          qtyDiv.textContent = 'Cantidad: ' + displayQty;

          var unitsDiv = document.createElement('div');
          unitsDiv.className = 'unit-checkboxes';

          for (var j = 0; j < item.quantity; j++) {
            var unitCb = document.createElement('input');
            unitCb.type = 'checkbox';
            unitCb.className = 'unit-checkbox';
            unitCb.setAttribute('data-item', i);
            unitCb.setAttribute('data-unit', j);
            unitsDiv.appendChild(unitCb);
          }

          info.appendChild(descDiv);
          info.appendChild(skuDiv);
          info.appendChild(qtyDiv);
          info.appendChild(unitsDiv);
          card.appendChild(mainCheckbox);
          card.appendChild(info);

          // Bot√≥n de foto para verificaci√≥n (solo items normales)
          if (!item.isVerificationOnly) {
            var verifyBtn = document.createElement('button');
            verifyBtn.className = 'verify-photo-btn';
            verifyBtn.textContent = 'üì∑';
            verifyBtn.title = 'Verificar con foto';
            verifyBtn.setAttribute('data-index', i);
            verifyBtn.onclick = function(e) {
              e.stopPropagation();
              var idx = parseInt(this.getAttribute('data-index'));
              iniciarVerificacionFoto(idx);
            };
            card.appendChild(verifyBtn);
          }

          itemsList.appendChild(card);
        }
        updateItemsCount();
      }

      itemsList.addEventListener('click', function(e) {
        if (e.target.classList.contains('unit-checkbox')) {
          var itemIndex = parseInt(e.target.getAttribute('data-item'));
          var unitIndex = parseInt(e.target.getAttribute('data-unit'));
          if (!unitChecks[itemIndex]) unitChecks[itemIndex] = [];
          unitChecks[itemIndex][unitIndex] = e.target.checked ? { checked: true, method: 'manual' } : null;
          updateCard(itemIndex);
        }
      });

      function searchCodigo(codigo) {
        if (!codigo || codigo.trim() === '') {
          showStatus('Ingresa un codigo ML', 'error');
          return;
        }
        if (!colectaActivaId) {
          showStatus('Seleccion√° una colecta primero', 'error');
          return;
        }
        codigo = codigo.trim().toUpperCase();

        // Verificar si ya tiene todas las unidades escaneadas
        var itemEnColecta = scannedItems[codigo];
        if (itemEnColecta && itemEnColecta.cantidad > 0 && itemEnColecta.cantidadVerificada >= itemEnColecta.cantidad) {
          showAllScannedAlert(codigo, itemEnColecta.cantidad);
          stopCamera();
          return;
        }

        showStatus('Buscando...', 'loading');
        searchBtn.disabled = true;

        fetch('/api/codigo/' + encodeURIComponent(codigo), { credentials: 'include' })
          .then(function(response) {
            return response.json().then(function(data) {
              if (!response.ok) throw new Error(data.error || 'Codigo no encontrado');
              return data;
            });
          })
          .then(function(data) {
            currentCodigo = data;
            currentItems = data.items;
            unitChecks = {};
            hideStatus();
            itemsSection.classList.remove('hidden');
            resetBtn.classList.remove('hidden');
            itemsCuenta.textContent = data.cuenta;

            // Mostrar estado de colectas (m√∫ltiples)
            var colectaBadges = '';
            if (data.colectas && data.colectas.length > 0) {
              data.colectas.forEach(function(col) {
                if (col.verificado) {
                  colectaBadges += '<span class="colecta-status-badge verificado">VERIFICADO</span>';
                } else {
                  colectaBadges += '<span class="colecta-status-badge en-colecta">EN COLECTA</span>';
                }
              });
            } else if (colectasData.length > 0) {
              colectaBadges = '<span class="colecta-status-badge no-colecta">NO EN COLECTAS</span>';
            }

            itemsProducto.innerHTML = (data.producto ? ' - ' + data.producto.substring(0, 30) + '...' : '') + colectaBadges;
            renderItems();
            stopCamera();
            visionResult.classList.add('hidden');
          })
          .catch(function(error) {
            showStatus(error.message, 'error');
            itemsSection.classList.add('hidden');
          })
          .finally(function() {
            searchBtn.disabled = false;
          });
      }

      // Event listeners
      searchBtn.onclick = function() {
        searchCodigo(codigoInput.value);
      };

      codigoInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          searchCodigo(codigoInput.value);
        }
      });

      resetBtn.onclick = function() {
        currentItems = [];
        unitChecks = {};
        currentCodigo = null;
        itemsSection.classList.add('hidden');
        resetBtn.classList.add('hidden');
        completeBanner.classList.remove('show');
        visionResult.classList.add('hidden');
        codigoInput.value = '';
        codigoInput.focus();
      };

      // ============================================
      // ESC√ÅNER DE C√ìDIGO DE BARRAS
      // ============================================
      cameraBtn.onclick = function() {
        if (isScanning) {
          stopCamera();
        } else {
          startCamera();
        }
      };

      closeCameraBtn.onclick = stopCamera;

      function startCamera() {
        cameraContainer.classList.add('active');
        isScanning = true;
        cameraBtn.textContent = 'Cerrar camara';

        if (!codeReader) {
          // Configuraci√≥n mejorada para mejor lectura de c√≥digos
          var hints = new Map();
          hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
          hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
            ZXing.BarcodeFormat.QR_CODE,
            ZXing.BarcodeFormat.CODE_128,
            ZXing.BarcodeFormat.CODE_39,
            ZXing.BarcodeFormat.EAN_13,
            ZXing.BarcodeFormat.EAN_8,
            ZXing.BarcodeFormat.UPC_A,
            ZXing.BarcodeFormat.UPC_E,
            ZXing.BarcodeFormat.DATA_MATRIX
          ]);
          codeReader = new ZXing.BrowserMultiFormatReader(hints);
        }

        // Usar c√°mara trasera con mayor resoluci√≥n
        var constraints = {
          video: {
            facingMode: 'environment',
            width: { ideal: 1920 },
            height: { ideal: 1080 },
            focusMode: 'continuous'
          }
        };

        codeReader.decodeFromConstraints(constraints, video, function(result, err) {
          if (result) {
            var code = result.getText();
            if (navigator.vibrate) navigator.vibrate(100);
            codigoInput.value = code;
            searchCodigo(code);
          }
        }).catch(function(err) {
          console.error('Error iniciando camara:', err);
          showStatus('Error al acceder a la camara', 'error');
          stopCamera();
        });
      }

      function stopCamera() {
        if (codeReader) {
          codeReader.reset();
        }
        cameraContainer.classList.remove('active');
        isScanning = false;
        cameraBtn.textContent = 'Escanear codigo';
      }

      // ============================================
      // VERIFICACI√ìN CON C√ÅMARA (Claude Vision)
      // ============================================
      function iniciarVerificacionFoto(itemIndex) {
        photoItemIndex = itemIndex;
        var item = currentItems[itemIndex];
        visionProductName.textContent = item.description || item.sku || 'Producto';
        abrirVisionCamera();
      }

      function abrirVisionCamera() {
        visionCameraModal.classList.remove('hidden');
        visionAnalyzeBtn.disabled = false;
        visionAnalyzeBtn.innerHTML = '<span>üîç</span> Analizar';

        var constraints = {
          video: {
            facingMode: 'environment',
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          }
        };

        navigator.mediaDevices.getUserMedia(constraints)
          .then(function(stream) {
            visionStream = stream;
            visionVideo.srcObject = stream;
          })
          .catch(function(err) {
            console.error('Error accediendo a camara:', err);
            cerrarVisionCamera();
            showStatus('Error al acceder a la camara', 'error');
          });
      }

      function cerrarVisionCamera() {
        visionCameraModal.classList.add('hidden');
        if (visionStream) {
          visionStream.getTracks().forEach(function(track) { track.stop(); });
          visionStream = null;
        }
        visionVideo.srcObject = null;
        photoItemIndex = null;
      }

      visionCameraClose.onclick = cerrarVisionCamera;

      visionAnalyzeBtn.onclick = function() {
        if (photoItemIndex === null) return;
        var item = currentItems[photoItemIndex];

        // Capturar frame del video
        visionCanvas.width = visionVideo.videoWidth;
        visionCanvas.height = visionVideo.videoHeight;
        var ctx = visionCanvas.getContext('2d');
        ctx.drawImage(visionVideo, 0, 0);
        var base64 = visionCanvas.toDataURL('image/jpeg', 0.9);

        // Deshabilitar bot√≥n mientras analiza
        visionAnalyzeBtn.disabled = true;
        visionAnalyzeBtn.innerHTML = '<span>‚è≥</span> Analizando...';

        fetch('/api/vision/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            image: base64,
            producto: {
              sku: item.sku,
              descripcion: item.description,
              producto: currentCodigo ? currentCodigo.producto : ''
            }
          })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          cerrarVisionCamera();
          mostrarResultadoVision(data, photoItemIndex);
        })
        .catch(function(err) {
          visionAnalyzeBtn.disabled = false;
          visionAnalyzeBtn.innerHTML = '<span>üîç</span> Analizar';
          showStatus('Error analizando imagen', 'error');
        });
      };

      function mostrarResultadoVision(data, itemIndex) {
        var isCorrect = data.correcto !== false;
        visionResult.className = 'vision-result ' + (isCorrect ? 'correct' : 'incorrect');

        var html = '<h4>' + (isCorrect ? '‚úÖ Verificado' : '‚ùå No coincide') + '</h4>';
        if (data.modeloDetectado) html += '<p><strong>Modelo:</strong> ' + data.modeloDetectado + '</p>';
        if (data.colorDetectado) html += '<p><strong>Color:</strong> ' + data.colorDetectado + '</p>';
        if (data.productoDetectado) html += '<p><strong>Detectado:</strong> ' + data.productoDetectado + '</p>';
        if (data.motivo) html += '<p><strong>Motivo:</strong> ' + data.motivo + '</p>';
        html += '<p><strong>Confianza:</strong> ' + (data.confianza || 'N/A') + '</p>';

        visionResult.innerHTML = html;
        visionResult.classList.remove('hidden');

        // Auto-marcar si es correcto
        if (isCorrect && itemIndex !== null) {
          var item = currentItems[itemIndex];
          if (!unitChecks[itemIndex]) unitChecks[itemIndex] = [];
          // Marcar primera unidad no marcada
          for (var i = 0; i < item.quantity; i++) {
            if (!unitChecks[itemIndex][i]) {
              unitChecks[itemIndex][i] = { checked: true, method: 'photo' };
              var checkbox = document.querySelector('.unit-checkbox[data-item="' + itemIndex + '"][data-unit="' + i + '"]');
              if (checkbox) checkbox.checked = true;
              break;
            }
          }
          updateCard(itemIndex);
          highlightCard(itemIndex);
        }

        photoItemIndex = null;
      }
    }
  </script>

  <!-- Transferencia de Stock - Solo Web (en secci√≥n Creaci√≥n) -->
  <script>
  (function transferInit() {
    // Detectar si es PWA instalada
    var isPWA = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

    // En PWA no inicializar
    if (isPWA) return;

    // Estado
    var shipmentData = [];
    var stockData = [];
    var stockHeaders = [];
    var transferResults = null;
    var pdfTotals = null;

    // Elementos (con sufijo 2 para los nuevos IDs)
    var transferPdfInput = document.getElementById('transferPdfInput2');
    var transferStockInput = document.getElementById('transferStockInput2');
    var transferPdfStatus = document.getElementById('transferPdfStatus2');
    var transferStockStatus = document.getElementById('transferStockStatus2');
    var transferPdfValidation = document.getElementById('transferPdfValidation2');
    var transferProcessBtn = document.getElementById('transferProcessBtn2');
    var transferResultsDiv = document.getElementById('transferResults2');
    var transferSuccess = document.getElementById('transferSuccess2');
    var transferErrors = document.getElementById('transferErrors2');
    var transferNotFound = document.getElementById('transferNotFound2');
    var transferSuccessList = document.getElementById('transferSuccessList2');
    var transferErrorsList = document.getElementById('transferErrorsList2');
    var transferNotFoundList = document.getElementById('transferNotFoundList2');
    var transferDownloadBtn = document.getElementById('transferDownloadBtn2');

    if (!transferPdfInput) return;

    // Parsear SKU: manejar "/" separadores y (n) multiplicadores
    function parseSkuString(skuStr, baseQty) {
      if (!skuStr) return [];
      var segments = skuStr.split('/').map(function(s) { return s.trim(); }).filter(function(s) { return s; });
      var skuMap = {};

      for (var i = 0; i < segments.length; i++) {
        var seg = segments[i];
        if (seg.match(/^5A/i)) continue;

        var cleanSeg = seg.replace(/\s+/g, '');
        var match = cleanSeg.match(/^(.+?)\((\d+)\)$/);
        var sku, multiplier;

        if (match) {
          sku = match[1].trim();
          multiplier = parseInt(match[2], 10);
        } else {
          sku = cleanSeg;
          multiplier = 1;
        }

        if (sku.match(/^5A/i)) continue;

        if (!skuMap[sku]) {
          skuMap[sku] = baseQty * multiplier;
        }
      }

      return Object.keys(skuMap).map(function(sku) {
        return { sku: sku, qty: skuMap[sku] };
      });
    }

    // Cargar PDF usando nuestro backend
    transferPdfInput.addEventListener('change', async function(e) {
      var file = e.target.files[0];
      if (!file) return;

      transferPdfStatus.textContent = 'Procesando PDF...';
      transferPdfStatus.classList.remove('error');
      transferPdfStatus.classList.add('show');
      transferPdfValidation.classList.add('hidden');

      var formData = new FormData();
      formData.append('pdf', file);

      try {
        var response = await fetch('/api/colecta/debug-pdf', {
          method: 'POST',
          body: formData,
          credentials: 'include'
        });

        var data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Error procesando PDF');
        }

        // Convertir items a formato shipmentData
        shipmentData = data.items.map(function(item) {
          return { rawSku: item.codigo, qty: item.cantidad };
        });

        pdfTotals = {
          productos: data.productosDeclarados,
          unidades: data.unidadesDeclaradas
        };

        var extractedUnits = shipmentData.reduce(function(sum, item) { return sum + item.qty; }, 0);

        transferPdfStatus.textContent = '‚úì ' + shipmentData.length + ' productos, ' + extractedUnits + ' unidades';
        transferPdfStatus.classList.remove('error');

        // Mostrar validaci√≥n
        if (data.validacion.ok) {
          transferPdfValidation.className = 'transfer-validation ok';
          transferPdfValidation.textContent = '‚úì Validaci√≥n OK - coincide con totales del PDF';
        } else {
          transferPdfValidation.className = 'transfer-validation error';
          transferPdfValidation.textContent = '‚úó ' + data.validacion.error;
        }
        transferPdfValidation.classList.remove('hidden');

        updateProcessButton();
      } catch (err) {
        transferPdfStatus.textContent = '‚úó ' + err.message;
        transferPdfStatus.classList.add('error');
        shipmentData = [];
        updateProcessButton();
      }
    });

    // Cargar Excel de stock
    transferStockInput.addEventListener('change', async function(e) {
      var file = e.target.files[0];
      if (!file) return;

      transferStockStatus.textContent = 'Leyendo archivo...';
      transferStockStatus.classList.remove('error');
      transferStockStatus.classList.add('show');

      try {
        var ext = file.name.split('.').pop().toLowerCase();

        if (ext === 'csv') {
          var text = await file.text();
          var lines = text.split('\n');
          var headers = lines[0].split(',').map(function(h) { return h.trim().replace(/^"|"$/g, ''); });
          stockHeaders = headers;
          stockData = [];

          for (var i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            var values = lines[i].split(',').map(function(v) { return v.trim().replace(/^"|"$/g, ''); });
            var row = {};
            for (var j = 0; j < headers.length; j++) {
              row[headers[j]] = values[j] || '';
            }
            if (row.sku || row.sku_variante) {
              stockData.push(row);
            }
          }
        } else if (typeof XLSX !== 'undefined') {
          var buffer = await file.arrayBuffer();
          var wb = XLSX.read(buffer, { type: 'array' });
          var ws = wb.Sheets[wb.SheetNames[0]];
          var data = XLSX.utils.sheet_to_json(ws, { defval: '', raw: true });

          if (data.length > 0) {
            stockHeaders = Object.keys(data[0]);
            stockData = data.filter(function(row) {
              return Object.keys(row).some(function(key) {
                return key.toLowerCase().includes('sku') && row[key] && row[key].toString().trim() !== '';
              });
            });
          }
        }

        transferStockStatus.textContent = '‚úì ' + stockData.length + ' productos en stock';
        transferStockStatus.classList.remove('error');
        updateProcessButton();
      } catch (err) {
        transferStockStatus.textContent = '‚úó Error: ' + err.message;
        transferStockStatus.classList.add('error');
        stockData = [];
        updateProcessButton();
      }
    });

    function updateProcessButton() {
      transferProcessBtn.disabled = !(shipmentData.length > 0 && stockData.length > 0);
    }

    // Buscar fila en stock por SKU
    function findStockRow(sku, data) {
      var skuLower = sku.toLowerCase().trim();

      var idx = data.findIndex(function(row) {
        return row.sku_variante && row.sku_variante.toString().trim().toLowerCase() === skuLower;
      });

      if (idx === -1) {
        idx = data.findIndex(function(row) {
          return row.sku && row.sku.toString().trim().toLowerCase() === skuLower;
        });
      }

      if (idx === -1) {
        idx = data.findIndex(function(row) {
          var variante = row.sku_variante ? row.sku_variante.toString().trim().toLowerCase() : '';
          return variante.includes(skuLower) || skuLower.includes(variante);
        });
      }

      return idx;
    }

    // Procesar transferencia
    transferProcessBtn.addEventListener('click', function() {
      if (shipmentData.length === 0 || stockData.length === 0) return;

      var updatedStock = JSON.parse(JSON.stringify(stockData));
      var log = [];
      var errors = [];
      var notFound = [];

      for (var i = 0; i < shipmentData.length; i++) {
        var item = shipmentData[i];
        var parsedSkus = parseSkuString(item.rawSku, item.qty);

        for (var j = 0; j < parsedSkus.length; j++) {
          var parsed = parsedSkus[j];
          var sku = parsed.sku;
          var qty = parsed.qty;

          var rowIdx = findStockRow(sku, updatedStock);

          if (rowIdx === -1) {
            notFound.push({ sku: sku, qty: qty, rawSku: item.rawSku });
            continue;
          }

          var row = updatedStock[rowIdx];
          var currentStock = parseInt(row.deposito_cantidad1, 10) || 0;

          if (currentStock < qty) {
            errors.push({ sku: sku, requested: qty, available: currentStock });
            continue;
          }

          var currentDep2 = parseInt(row.deposito_cantidad2, 10) || 0;

          row.deposito_cantidad1 = currentStock - qty;
          row.deposito_cantidad2 = currentDep2 + qty;

          log.push({
            sku: sku,
            qty: qty,
            dep1Before: currentStock,
            dep1After: row.deposito_cantidad1,
            dep2Before: currentDep2,
            dep2After: row.deposito_cantidad2
          });
        }
      }

      transferResults = { updatedStock: updatedStock, log: log, errors: errors, notFound: notFound };
      showResults();
    });

    function showResults() {
      if (!transferResults) return;

      transferResultsDiv.classList.remove('hidden');

      // Exitosos
      if (transferResults.log.length > 0) {
        transferSuccess.classList.remove('hidden');
        transferSuccessList.innerHTML = transferResults.log.map(function(l) {
          return '<li><strong>' + l.sku + '</strong>: ' + l.qty + ' uds (Dep1: ' + l.dep1Before + '‚Üí' + l.dep1After + ', Dep2: ' + l.dep2Before + '‚Üí' + l.dep2After + ')</li>';
        }).join('');
      } else {
        transferSuccess.classList.add('hidden');
      }

      // Errores stock
      if (transferResults.errors.length > 0) {
        transferErrors.classList.remove('hidden');
        transferErrorsList.innerHTML = transferResults.errors.map(function(e) {
          return '<li><strong>' + e.sku + '</strong>: necesita ' + e.requested + ', tiene ' + e.available + '</li>';
        }).join('');
      } else {
        transferErrors.classList.add('hidden');
      }

      // No encontrados
      if (transferResults.notFound.length > 0) {
        transferNotFound.classList.remove('hidden');
        transferNotFoundList.innerHTML = transferResults.notFound.map(function(n) {
          return '<li><strong>' + n.sku + '</strong> (cant: ' + n.qty + ')</li>';
        }).join('');
      } else {
        transferNotFound.classList.add('hidden');
      }

      // Mostrar bot√≥n descarga si hay cambios
      if (transferResults.log.length > 0) {
        transferDownloadBtn.classList.remove('hidden');
      } else {
        transferDownloadBtn.classList.add('hidden');
      }
    }

    // Descargar Excel actualizado
    transferDownloadBtn.addEventListener('click', function() {
      if (!transferResults || typeof XLSX === 'undefined') return;

      var wb = XLSX.utils.book_new();
      var headers = stockHeaders.length > 0 ? stockHeaders : Object.keys(transferResults.updatedStock[0] || {});

      // Filtrar solo filas modificadas
      var modifiedSkus = {};
      transferResults.log.forEach(function(l) {
        modifiedSkus[l.sku.toLowerCase().trim()] = true;
      });

      var modifiedRows = transferResults.updatedStock.filter(function(row) {
        var sku = row.sku ? row.sku.toString().trim().toLowerCase() : '';
        var variante = row.sku_variante ? row.sku_variante.toString().trim().toLowerCase() : '';

        for (var modSku in modifiedSkus) {
          if (sku === modSku || variante === modSku) return true;
          if (variante && (variante.includes(modSku) || modSku.includes(variante))) return true;
        }
        return false;
      });

      var wsData = [headers];
      modifiedRows.forEach(function(row) {
        var rowData = headers.map(function(h) { return row[h] !== undefined ? row[h] : ''; });
        wsData.push(rowData);
      });

      var ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, 'Stock Modificado');

      XLSX.writeFile(wb, 'stock_actualizado.xlsx');
    });
  })();
  </script>

  <!-- Tabs internos de Creaci√≥n -->
  <script>
  (function creacionTabsInit() {
    var isPWA = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    if (isPWA) return;

    document.querySelectorAll('.creacion-tab').forEach(function(tab) {
      tab.onclick = function() {
        document.querySelectorAll('.creacion-tab').forEach(function(t) { t.classList.remove('active'); });
        document.querySelectorAll('.creacion-content').forEach(function(c) { c.classList.remove('active'); });
        this.classList.add('active');
        var tabId = this.getAttribute('data-tab');
        var content = document.getElementById('tab' + tabId.charAt(0).toUpperCase() + tabId.slice(1));
        if (content) content.classList.add('active');
      };
    });
  })();
  </script>

  <!-- Planificador de Env√≠os FULL -->
  <script>
  (function plannerInit() {
    var isPWA = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    if (isPWA) return;

    var MIN_STOCK_RESERVE = 10;
    var meliFiles = [{ name: null, data: null }, { name: null, data: null }, { name: null, data: null }];
    var stockData = null;
    var mayoristaData = null;
    var plannerResultsData = null;
    var plannerErrors = [];

    // Elementos
    var meliInputs = [
      document.getElementById('plannerMeli1'),
      document.getElementById('plannerMeli2'),
      document.getElementById('plannerMeli3')
    ];
    var meliStatuses = [
      document.getElementById('plannerMeli1Status'),
      document.getElementById('plannerMeli2Status'),
      document.getElementById('plannerMeli3Status')
    ];
    var stockInput = document.getElementById('plannerStock');
    var stockStatus = document.getElementById('plannerStockStatus');
    var mayoristaInput = document.getElementById('plannerMayorista');
    var mayoristaStatus = document.getElementById('plannerMayoristaStatus');
    var processBtn = document.getElementById('plannerProcessBtn');
    var exportBtn = document.getElementById('plannerExportBtn');
    var warningsDiv = document.getElementById('plannerWarnings');
    var warningsList = document.getElementById('plannerWarningsList');
    var resultsDiv = document.getElementById('plannerResults');
    var resultsCount = document.getElementById('plannerResultsCount');
    var sugeridas = document.getElementById('plannerSugeridas');
    var aEnviar = document.getElementById('plannerAEnviar');
    var validationDiv = document.getElementById('plannerValidation');
    var tableBody = document.getElementById('plannerTableBody');

    if (!processBtn) return;

    function parseNumber(value) {
      if (value === null || value === undefined || value === '' || value === '-') return 0;
      var str = value.toString().trim();
      if (str === '-' || str === '') return 0;
      var cleaned = str.replace(/[^\d]/g, '');
      var num = parseInt(cleaned);
      return isNaN(num) ? 0 : num;
    }

    function categorizeItem(item) {
      var recLower = (item.recommendation || '').toLowerCase().trim();
      if (recLower.includes('desvinculaste') || recLower.includes('no ten√©s recomendaci√≥n')) return 'desvinculado';
      if (recLower.includes('no enviar') || recLower.includes('recomendamos no') || recLower.includes('desactivaste')) return 'excluir';
      if (!recLower.includes('envi') && item.suggestedUnits > 0) return 'sinRecomendacion';
      if (!recLower.includes('envi')) return 'excluir';
      if (item.unitsToSend === 0) return 'excluir';
      if (item.unitsToSend < item.suggestedUnits) return 'insuficiente';
      return 'ok';
    }

    function parseSkuComponent(component) {
      if (!component) return { sku: '', quantity: 1 };
      var trimmed = component.trim();
      var packMatch = trimmed.match(/^(.+)\((\d+)\)$/);
      if (packMatch) return { sku: packMatch[1].trim(), quantity: parseInt(packMatch[2]) || 1 };
      return { sku: trimmed, quantity: 1 };
    }

    function isAnilloSegment(segment) {
      if (!segment) return false;
      var upper = segment.toUpperCase().trim();
      return upper === 'ANILLO' || upper === 'ANILLO+V';
    }

    function parseSku(sku) {
      if (!sku || typeof sku !== 'string') return [];
      var workingSku = sku.trim();
      if (!workingSku) return [];
      if (workingSku.startsWith('5') && workingSku.indexOf('/') !== -1) {
        var parts = workingSku.split('/');
        return parts.slice(1).map(parseSkuComponent).filter(function(c) { return c.sku.length > 0 && !isAnilloSegment(c.sku); });
      }
      if (workingSku.indexOf('/') !== -1) {
        return workingSku.split('/').map(parseSkuComponent).filter(function(c) { return c.sku.length > 0 && !isAnilloSegment(c.sku); });
      }
      if (isAnilloSegment(workingSku)) return [];
      var parsed = parseSkuComponent(workingSku);
      return parsed.sku.length > 0 ? [parsed] : [];
    }

    function findStockForSku(skuToFind, stockRows) {
      if (!skuToFind || !stockRows) return { found: false, stock: 0, matchType: null };
      for (var i = 0; i < stockRows.length; i++) {
        var row = stockRows[i];
        var sku = (row.sku || '').toString().trim();
        var skuVariante = (row.sku_variante || '').toString().trim();
        if (sku === skuToFind) return { found: true, stock: parseNumber(row.deposito_cantidad1), matchType: 'sku' };
        if (skuVariante === skuToFind) return { found: true, stock: parseNumber(row.deposito_cantidad1), matchType: 'sku_variante' };
      }
      return { found: false, stock: 0, matchType: null };
    }

    function getMayoristaVentas(skuToFind, mayoristaRows) {
      if (!mayoristaRows || !skuToFind) return 0;
      for (var i = 0; i < mayoristaRows.length; i++) {
        var row = mayoristaRows[i];
        var sku = (row.sku || '').toString().trim();
        var skuVariante = (row.sku_variante || '').toString().trim();
        if (sku === skuToFind || skuVariante === skuToFind) return parseNumber(row.Vendidos);
      }
      return 0;
    }

    function getCategoryLabel(cat) {
      var labels = {
        'insuficiente': 'üî¥ Insuf.',
        'ok': 'üü¢ OK',
        'noEncontrado': '‚ö´ No enc.',
        'sinRecomendacion': 'üü° Sin rec.',
        'sinSku': 'üü£ Sin SKU',
        'excluir': '‚ö™ Excluido',
        'desvinculado': 'üîµ Desvinc.'
      };
      return labels[cat] || cat || '';
    }

    function updateProcessButton() {
      var hasMeli = meliFiles.some(function(f) { return f.data; });
      processBtn.disabled = !(stockData && hasMeli);
    }

    function readExcelFile(file, callback, skipRows) {
      var reader = new FileReader();
      reader.onload = function(evt) {
        try {
          var wb = XLSX.read(evt.target.result, { type: 'array' });
          var ws = wb.Sheets[wb.SheetNames[0]];
          var data;
          if (skipRows) {
            data = XLSX.utils.sheet_to_json(ws, { range: skipRows });
          } else {
            data = XLSX.utils.sheet_to_json(ws);
          }
          callback(null, data);
        } catch (err) {
          callback(err, null);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function readMeliFile(file, callback) {
      var reader = new FileReader();
      reader.onload = function(evt) {
        try {
          var wb = XLSX.read(evt.target.result, { type: 'array' });
          var ws = wb.Sheets[wb.SheetNames[0]];
          var allData = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '', blankrows: true, raw: false });

          var headerRowIndex = -1;
          for (var i = 0; i < Math.min(allData.length, 20); i++) {
            if (allData[i] && allData[i].some(function(cell) { return cell && cell.toString().trim() === 'SKU'; })) {
              headerRowIndex = i;
              break;
            }
          }
          if (headerRowIndex === -1) { callback(new Error('No se encontr√≥ encabezado SKU'), null); return; }

          var headers = allData[headerRowIndex].map(function(h) {
            return h ? h.toString().trim().replace(/\n/g, ' ').replace(/\s+/g, ' ') : '';
          });
          var data = [];
          for (var i = headerRowIndex + 1; i < allData.length; i++) {
            var row = allData[i];
            if (!row || !row.some(function(cell) { return cell && cell.toString().trim(); })) continue;
            var obj = {};
            headers.forEach(function(h, j) { if (h) obj[h] = row[j] !== undefined ? row[j] : ''; });
            data.push(obj);
          }
          callback(null, data);
        } catch (err) {
          callback(err, null);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // Event listeners para archivos
    meliInputs.forEach(function(input, index) {
      if (!input) return;
      input.addEventListener('change', function(e) {
        var file = e.target.files[0];
        if (!file) return;
        meliStatuses[index].textContent = 'Leyendo...';
        meliStatuses[index].classList.remove('error');
        readMeliFile(file, function(err, data) {
          if (err) {
            meliStatuses[index].textContent = '‚úó ' + err.message;
            meliStatuses[index].classList.add('error');
            meliFiles[index] = { name: null, data: null };
          } else {
            meliStatuses[index].textContent = '‚úì ' + data.length + ' filas';
            meliFiles[index] = { name: file.name, data: data };
          }
          updateProcessButton();
        });
      });
    });

    if (stockInput) {
      stockInput.addEventListener('change', function(e) {
        var file = e.target.files[0];
        if (!file) return;
        stockStatus.textContent = 'Leyendo...';
        readExcelFile(file, function(err, data) {
          if (err) {
            stockStatus.textContent = '‚úó Error';
            stockStatus.classList.add('error');
            stockData = null;
          } else {
            stockStatus.textContent = '‚úì ' + data.length + ' productos';
            stockData = data;
          }
          updateProcessButton();
        });
      });
    }

    if (mayoristaInput) {
      mayoristaInput.addEventListener('change', function(e) {
        var file = e.target.files[0];
        if (!file) return;
        mayoristaStatus.textContent = 'Leyendo...';
        readExcelFile(file, function(err, data) {
          if (err) {
            mayoristaStatus.textContent = '‚úó Error';
            mayoristaData = null;
          } else {
            mayoristaStatus.textContent = '‚úì ' + data.length + ' productos';
            mayoristaData = data;
          }
        }, 2);
      });
    }

    // Procesar
    processBtn.addEventListener('click', function() {
      if (!stockData || meliFiles.every(function(f) { return !f.data; })) {
        alert('Falta cargar archivos: Stock y al menos un reporte de Meli');
        return;
      }

      var allPublicaciones = [];
      var notFound = [];
      var validacionPorCuenta = {};

      meliFiles.forEach(function(file, cuentaIndex) {
        if (!file.data) return;
        var cuentaName = file.name ? file.name.replace(/\.(xlsx|xls)$/i, '') : 'Cuenta ' + (cuentaIndex + 1);
        var sumaVerificacion = 0;

        for (var i = 0; i < file.data.length; i++) {
          var val = file.data[i]['Unidades sugeridas para enviar'];
          var num = parseNumber(val);
          if (num > 0) sumaVerificacion += num;
        }

        validacionPorCuenta[cuentaName] = { totalMeli: sumaVerificacion, totalProcesado: 0 };

        for (var i = 0; i < file.data.length; i++) {
          var meliRow = file.data[i];
          var originalSku = (meliRow['SKU'] || '').toString().trim();
          var suggestedUnits = parseNumber(meliRow['Unidades sugeridas para enviar']);
          var codigoML = (meliRow['C√≥digo ML'] || '').toString().trim();
          var recommendation = (meliRow['Recomendaci√≥n'] || '').toString().trim();

          if (!originalSku) {
            if (suggestedUnits > 0) {
              allPublicaciones.push({
                originalSku: '(SIN SKU)', codigoML: codigoML, recommendation: recommendation,
                suggestedUnits: suggestedUnits, skuComponents: [], cuenta: cuentaName, sinSku: true
              });
            }
            continue;
          }

          var skuComponents = parseSku(originalSku);
          if (skuComponents.length === 0) {
            notFound.push({ sku: originalSku, cuenta: cuentaName, reason: 'SKU inv√°lido', unidades: suggestedUnits });
            continue;
          }

          allPublicaciones.push({
            originalSku: originalSku, codigoML: codigoML, recommendation: recommendation,
            suggestedUnits: suggestedUnits, skuComponents: skuComponents, cuenta: cuentaName
          });
        }
      });

      // Agrupar por SKU
      var demandaPorSku = {};
      var processed = [];

      for (var i = 0; i < allPublicaciones.length; i++) {
        var pub = allPublicaciones[i];
        if (pub.sinSku) {
          processed.push({
            originalSku: pub.originalSku, codigoML: pub.codigoML, recommendation: pub.recommendation,
            suggestedUnits: pub.suggestedUnits, availableStock: 0, unitsToSend: 0, stockAfterSend: 0,
            cuenta: pub.cuenta, mayoristaReservado: 0, category: 'sinSku'
          });
          continue;
        }

        var mainComponent = pub.skuComponents[0];
        if (!mainComponent) continue;
        var skuKey = mainComponent.sku;

        if (!demandaPorSku[skuKey]) {
          demandaPorSku[skuKey] = { publicaciones: [], totalDemandaMeli: 0, mayoristaVentas: 0, stockInfo: null, multiplier: mainComponent.quantity };
        }
        demandaPorSku[skuKey].publicaciones.push(pub);
        demandaPorSku[skuKey].totalDemandaMeli += pub.suggestedUnits * mainComponent.quantity;
      }

      // Buscar stock
      Object.keys(demandaPorSku).forEach(function(skuKey) {
        demandaPorSku[skuKey].stockInfo = findStockForSku(skuKey, stockData);
        demandaPorSku[skuKey].mayoristaVentas = getMayoristaVentas(skuKey, mayoristaData);

        if (!demandaPorSku[skuKey].stockInfo.found) {
          demandaPorSku[skuKey].publicaciones.forEach(function(pub) {
            notFound.push({ sku: pub.originalSku, component: skuKey, cuenta: pub.cuenta, reason: 'SKU no encontrado', unidades: pub.suggestedUnits });
          });
        }
      });

      // Procesar cada grupo
      Object.keys(demandaPorSku).forEach(function(skuKey) {
        var grupo = demandaPorSku[skuKey];

        if (!grupo.stockInfo || !grupo.stockInfo.found) {
          grupo.publicaciones.forEach(function(pub) {
            processed.push({
              originalSku: pub.originalSku, codigoML: pub.codigoML, recommendation: pub.recommendation,
              suggestedUnits: pub.suggestedUnits, availableStock: 0, unitsToSend: 0, stockAfterSend: 0,
              cuenta: pub.cuenta, mayoristaReservado: 0, category: 'noEncontrado'
            });
          });
          return;
        }

        var stockDisponible = grupo.stockInfo.stock;
        var stockUtilizable = Math.max(0, stockDisponible - MIN_STOCK_RESERVE);
        var demandaTotal = grupo.totalDemandaMeli + grupo.mayoristaVentas;

        var ratio = 1;
        if (demandaTotal > stockUtilizable && demandaTotal > 0) ratio = stockUtilizable / demandaTotal;

        var stockUsadoMeli = 0;
        var itemsDelGrupo = [];

        grupo.publicaciones.forEach(function(pub) {
          var multiplier = pub.skuComponents[0] ? pub.skuComponents[0].quantity : 1;
          var asignadoStock = Math.floor(pub.suggestedUnits * multiplier * ratio);
          var unitsToSend = Math.floor(asignadoStock / multiplier);
          stockUsadoMeli += unitsToSend * multiplier;

          var item = {
            originalSku: pub.originalSku, codigoML: pub.codigoML, recommendation: pub.recommendation,
            suggestedUnits: pub.suggestedUnits, availableStock: Math.floor(stockDisponible / multiplier),
            unitsToSend: unitsToSend, stockAfterSend: 0, cuenta: pub.cuenta, mayoristaReservado: 0
          };
          itemsDelGrupo.push(item);
          processed.push(item);
        });

        var stockParaMayorista = Math.floor(grupo.mayoristaVentas * ratio);
        var stockRestante = stockDisponible - stockUsadoMeli - stockParaMayorista;

        itemsDelGrupo.forEach(function(item) {
          item.stockAfterSend = stockRestante;
          item.mayoristaReservado = stockParaMayorista;
          item.category = categorizeItem(item);
        });
      });

      // Validaci√≥n
      processed.forEach(function(item) {
        if (validacionPorCuenta[item.cuenta]) {
          validacionPorCuenta[item.cuenta].totalProcesado += item.suggestedUnits;
        }
      });

      // Ordenar
      processed.sort(function(a, b) {
        var order = { 'insuficiente': 1, 'ok': 2, 'noEncontrado': 3, 'sinRecomendacion': 4, 'sinSku': 5, 'excluir': 6 };
        return (order[a.category] || 99) - (order[b.category] || 99);
      });

      // Guardar resultados
      plannerResultsData = { main: processed, validacion: validacionPorCuenta };
      plannerErrors = notFound;

      // Mostrar resultados
      renderResults();
    });

    function renderResults() {
      if (!plannerResultsData) return;

      var main = plannerResultsData.main;
      var validacion = plannerResultsData.validacion;

      // Warnings
      if (plannerErrors.length > 0) {
        warningsDiv.classList.remove('hidden');
        warningsList.innerHTML = plannerErrors.map(function(e) {
          return '<div>[' + e.cuenta + '] ' + e.sku + ' - ' + e.unidades + ' uds</div>';
        }).join('');
      } else {
        warningsDiv.classList.add('hidden');
      }

      // Results
      resultsDiv.classList.remove('hidden');
      exportBtn.classList.remove('hidden');

      var totalSugeridas = main.reduce(function(s, r) { return s + r.suggestedUnits; }, 0);
      var totalEnviar = main.reduce(function(s, r) { return s + r.unitsToSend; }, 0);

      resultsCount.textContent = main.length + ' productos';
      sugeridas.textContent = totalSugeridas;
      aEnviar.textContent = totalEnviar;

      // Validaci√≥n
      var valHtml = '';
      Object.keys(validacion).forEach(function(c) {
        var v = validacion[c];
        var icon = v.totalMeli === v.totalProcesado ? '‚úì' : '‚ö†Ô∏è Diff=' + (v.totalMeli - v.totalProcesado);
        valHtml += c + ': Meli=' + v.totalMeli + ' Proc=' + v.totalProcesado + ' ' + icon + ' | ';
      });
      validationDiv.innerHTML = valHtml;

      // Tabla
      tableBody.innerHTML = main.map(function(r) {
        return '<tr>' +
          '<td><span class="planner-cat ' + r.category + '">' + getCategoryLabel(r.category) + '</span></td>' +
          '<td>' + r.cuenta + '</td>' +
          '<td class="font-mono">' + r.originalSku.substring(0, 25) + '</td>' +
          '<td>' + (r.recommendation || '').substring(0, 15) + '</td>' +
          '<td class="text-right">' + r.suggestedUnits + '</td>' +
          '<td class="text-right">' + r.availableStock + '</td>' +
          '<td class="text-right font-bold">' + r.unitsToSend + '</td>' +
          '<td class="text-right">' + r.mayoristaReservado + '</td>' +
          '<td class="text-right">' + r.stockAfterSend + '</td>' +
          '</tr>';
      }).join('');
    }

    // Exportar
    exportBtn.addEventListener('click', function() {
      if (!plannerResultsData || typeof XLSX === 'undefined') return;

      var wb = XLSX.utils.book_new();
      var cuentas = [];
      plannerResultsData.main.forEach(function(r) {
        if (cuentas.indexOf(r.cuenta) === -1) cuentas.push(r.cuenta);
      });

      cuentas.forEach(function(cuenta) {
        var data = plannerResultsData.main.filter(function(r) { return r.cuenta === cuenta; }).map(function(r) {
          return {
            'Estado': getCategoryLabel(r.category),
            'SKU': r.originalSku,
            'C√≥digo ML': r.codigoML,
            'Recomendaci√≥n': r.recommendation,
            'Unidades Sugeridas': r.suggestedUnits,
            'Stock Disponible': r.availableStock,
            'Unidades a Enviar': r.unitsToSend,
            'Reservado Mayorista': r.mayoristaReservado,
            'Stock Restante': r.stockAfterSend
          };
        });
        if (data.length) {
          var sheetName = cuenta.substring(0, 31).replace(/[\\/*?:\[\]]/g, '');
          XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), sheetName);
        }
      });

      if (plannerErrors.length > 0) {
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(plannerErrors), 'No Encontrados');
      }

      if (!wb.SheetNames.length) {
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet([{ Info: 'Sin datos' }]), 'Info');
      }

      var blob = new Blob([XLSX.write(wb, { bookType: 'xlsx', type: 'array' })], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'envio_full_' + new Date().toISOString().split('T')[0] + '.xlsx';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });
  })();
  </script>

  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js').then(function(registration) {
          console.log('SW registrado:', registration.scope);
        }).catch(function(error) {
          console.log('SW error:', error);
        });
      });
    }
  </script>
</body>
</html>
