<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#059669">
  <title>Colectas FULL</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <!-- Login Overlay -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-box">
      <div class="login-logo">
        <h1>Colectas FULL</h1>
        <p>Inicia sesion para continuar</p>
      </div>
      <form class="login-form" id="loginForm">
        <input type="text" class="login-input" id="loginUser" placeholder="Usuario" autocomplete="username" required>
        <input type="password" class="login-input" id="loginPassword" placeholder="Contrasena" autocomplete="current-password" required>
        <div class="login-error" id="loginError">Usuario o contrasena incorrectos</div>
        <button type="submit" class="login-btn" id="loginBtn">Iniciar Sesion</button>
      </form>
    </div>
  </div>

  <!-- Celebration Overlay -->
  <div class="celebration-overlay" id="celebrationOverlay">
    <div class="celebration-text" id="celebrationText">COLECTA<br>COMPLETADA</div>
    <div class="celebration-subtext" id="celebrationSubtext"></div>
  </div>
  <div class="confetti-container" id="confettiContainer"></div>

  <!-- All Scanned Alert Overlay -->
  <div class="all-scanned-overlay" id="allScannedOverlay">
    <div class="all-scanned-icon">‚ö†Ô∏è</div>
    <div class="all-scanned-text">TODAS LAS UNIDADES<br>YA ESTAN ESCANEADAS</div>
    <div class="all-scanned-subtext" id="allScannedSubtext"></div>
  </div>

  <!-- Item Complete Alert Overlay -->
  <div class="item-complete-overlay" id="itemCompleteOverlay">
    <div class="item-complete-icon">‚úì</div>
    <div class="item-complete-text">ITEM<br>COMPLETO</div>
    <div class="item-complete-subtext" id="itemCompleteSubtext"></div>
  </div>

  <!-- Logout Button -->
  <button type="button" class="logout-btn hidden" id="logoutBtn">Salir</button>

  <div class="header" id="mainHeader">
    <h1>Colectas FULL</h1>
    <div class="main-tabs" id="mainTabs">
      <button type="button" class="main-tab" data-section="creacion">
        <span class="main-tab-icon">üì¶</span>
        <span class="main-tab-text">Creaci√≥n</span>
      </button>
      <button type="button" class="main-tab active" data-section="seguimiento">
        <span class="main-tab-icon">üìã</span>
        <span class="main-tab-text">Seguimiento</span>
      </button>
    </div>
  </div>

  <div class="container">
    <!-- SECCI√ìN: Creaci√≥n de Colectas (solo web) -->
    <div class="main-section" id="sectionCreacion">
      <!-- Descargar plantilla ML -->
      <a href="/plantilla-ml.xlsx" download="Excel para subir a ML.xlsx" class="plantilla-download-link">
        üì• Descargar plantilla Excel para MercadoLibre
      </a>

      <!-- Tabs internos -->
      <div class="creacion-tabs">
        <button type="button" class="creacion-tab active" data-tab="planificador">
          <span class="creacion-tab-icon">üìä</span>
          1. Planificador
        </button>
        <button type="button" class="creacion-tab" data-tab="transferencia">
          <span class="creacion-tab-icon">üîÑ</span>
          2. Transferencia
        </button>
      </div>

      <!-- Tab: Planificador -->
      <div class="creacion-content active" id="tabPlanificador">
        <div class="planner-section">
          <h2>üìä Planificador de Env√≠os FULL</h2>
          <p>Calcul√° cu√°ntas unidades enviar seg√∫n las sugerencias de MeLi, tu stock disponible y ventas mayoristas.</p>

          <div class="planner-grid">
            <div class="planner-file-box">
              <label>MeLi Cuenta 1</label>
              <input type="file" id="plannerMeli1" accept=".xlsx,.xls">
              <div class="file-status" id="plannerMeli1Status"></div>
            </div>
            <div class="planner-file-box">
              <label>MeLi Cuenta 2</label>
              <input type="file" id="plannerMeli2" accept=".xlsx,.xls">
              <div class="file-status" id="plannerMeli2Status"></div>
            </div>
            <div class="planner-file-box">
              <label>MeLi Cuenta 3</label>
              <input type="file" id="plannerMeli3" accept=".xlsx,.xls">
              <div class="file-status" id="plannerMeli3Status"></div>
            </div>
          </div>

          <div class="planner-grid-2">
            <div class="planner-file-box">
              <label>Stock ERP * <small style="font-weight: normal; color: #6b7280;">(Subir archivo Stock y precios de art√≠culos)</small></label>
              <input type="file" id="plannerStock" accept=".xlsx,.xls">
              <div class="file-status" id="plannerStockStatus"></div>
            </div>
            <div class="planner-file-box">
              <label>Mayorista (opcional)</label>
              <input type="file" id="plannerMayorista" accept=".xlsx,.xls">
              <div class="file-status" id="plannerMayoristaStatus"></div>
            </div>
          </div>

          <div class="planner-buttons">
            <button type="button" class="planner-btn primary" id="plannerProcessBtn" disabled>Procesar</button>
            <button type="button" class="planner-btn success hidden" id="plannerExportBtn">Exportar Excel</button>
          </div>

          <div class="planner-warnings hidden" id="plannerWarnings">
            <h4>‚ö†Ô∏è SKUs no encontrados</h4>
            <div class="planner-warnings-list" id="plannerWarningsList"></div>
          </div>

          <div class="planner-results hidden" id="plannerResults">
            <div class="planner-results-header">
              <span id="plannerResultsCount">0 productos</span>
              <span>Sugeridas: <strong id="plannerSugeridas">0</strong> | A enviar: <strong id="plannerAEnviar">0</strong></span>
            </div>
            <div class="planner-validation" id="plannerValidation"></div>
            <div class="planner-table-wrap">
              <table class="planner-table">
                <thead>
                  <tr>
                    <th>Estado</th>
                    <th>Cuenta</th>
                    <th>SKU</th>
                    <th>Rec.</th>
                    <th class="text-right">Sug.</th>
                    <th class="text-right">Disp.</th>
                    <th class="text-right">Enviar</th>
                    <th class="text-right">May.</th>
                    <th class="text-right">Rest.</th>
                  </tr>
                </thead>
                <tbody id="plannerTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab: Transferencia -->
      <div class="creacion-content" id="tabTransferencia">
        <div class="transfer-section" id="transferSectionCreacion" style="margin-top: 0; display: block;">
          <h2>üîÑ Transferencia de Stock</h2>
          <p style="font-size: 13px; color: #6b7280; margin-bottom: 16px;">Transfer√≠ stock del Dep√≥sito 1 al Dep√≥sito 2 bas√°ndote en un env√≠o FULL.</p>
          <div class="transfer-steps">
            <div class="transfer-step">
              <div class="transfer-step-header">
                <span class="transfer-step-num">1</span>
                <span class="transfer-step-title">PDF del Env√≠o FULL</span>
              </div>
              <input type="file" id="transferPdfInput2" accept=".pdf">
              <div class="transfer-step-status" id="transferPdfStatus2"></div>
              <div class="transfer-validation hidden" id="transferPdfValidation2"></div>
            </div>

            <div class="transfer-step">
              <div class="transfer-step-header">
                <span class="transfer-step-num">2</span>
                <span class="transfer-step-title">Excel de Stock (ERP) <small style="font-weight: normal; color: #6b7280;">(Subir archivo Art√≠culos simplificados)</small></span>
              </div>
              <input type="file" id="transferStockInput2" accept=".xlsx,.xls,.csv">
              <div class="transfer-step-status" id="transferStockStatus2"></div>
            </div>

            <button type="button" class="transfer-btn" id="transferProcessBtn2" disabled>
              Procesar Transferencia (Dep1 ‚Üí Dep2)
            </button>

            <div class="transfer-results hidden" id="transferResults2">
              <div class="transfer-result-box success hidden" id="transferSuccess2">
                <h4>‚úì Transferencias exitosas</h4>
                <ul id="transferSuccessList2"></ul>
              </div>
              <div class="transfer-result-box error hidden" id="transferErrors2">
                <h4>‚úó Stock insuficiente</h4>
                <ul id="transferErrorsList2"></ul>
              </div>
              <div class="transfer-result-box warning hidden" id="transferNotFound2">
                <h4>‚ö† SKUs no encontrados</h4>
                <ul id="transferNotFoundList2"></ul>
              </div>
              <div class="transfer-result-box hidden" id="transferValidation2">
                <h4>Verificaci√≥n de integridad</h4>
                <div id="transferValidationContent2"></div>
              </div>
              <button type="button" class="transfer-download-btn hidden" id="transferDownloadBtn2">
                ‚¨á Descargar Stock Actualizado (.xlsx)
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SECCI√ìN: Seguimiento (default) -->
    <div class="main-section active" id="sectionSeguimiento">
    <!-- Panel de Colectas -->
    <div class="colectas-panel" id="colectasPanel">
      <div class="colectas-header">
        <h2>Colectas FULL <span class="colectas-count" id="colectasCount">0</span></h2>
        <div class="colectas-tabs">
          <button type="button" class="colectas-tab" data-view="lista" id="tabLista">Lista</button>
          <button type="button" class="colectas-tab" data-view="calendario" id="tabCalendario">Calendario</button>
          <button type="button" class="colectas-tab active" data-view="verificar" id="tabVerificar">Verificar</button>
        </div>
      </div>

      <!-- Vista Lista -->
      <div class="colectas-list hidden" id="colectasLista"></div>

      <!-- Vista Calendario -->
      <div class="colectas-calendar hidden" id="colectasCalendario"></div>

      <!-- Vista Verificar -->
      <div class="colectas-verificar" id="colectasVerificar">
        <div class="verificar-selector">
          <label>Seleccion√° la colecta a verificar:</label>
          <select id="colectaActivaSelect">
            <option value="">-- Elegir colecta --</option>
          </select>
        </div>
        <div class="verificar-colecta-info hidden" id="verificarColectaInfo"></div>
      </div>

      <!-- Boton para mostrar formulario -->
      <button type="button" class="toggle-upload-btn" id="toggleUploadBtn">+ Nueva Colecta</button>

      <!-- Formulario de carga -->
      <div class="colecta-upload hidden" id="colectaUpload">
        <h3>Cargar nueva colecta</h3>
        <form class="colecta-upload-form" id="colectaForm">
          <label>Cuenta:</label>
          <select id="colectaCuentaInput">
            <option value="">Seleccionar cuenta...</option>
            <option value="Furst">Furst</option>
            <option value="Tienda">Tienda</option>
            <option value="Shop">Shop</option>
            <option value="Mun1">Mun1</option>
            <option value="Mun2">Mun2</option>
          </select>
          <label>Fecha de retiro:</label>
          <input type="date" id="colectaFechaInput" required>
          <label>PDF de la colecta FULL:</label>
          <input type="file" id="colectaPdfInput" accept=".pdf" required>
          <button type="submit" class="colecta-upload-btn" id="colectaUploadBtn">Cargar colecta</button>
        </form>
      </div>
    </div>

    <div class="scan-section">
      <div class="scan-input-group">
        <input type="text" id="codigoInput" class="scan-input" placeholder="Codigo ML...">
        <button type="button" id="searchBtn" class="scan-btn">Buscar</button>
      </div>
      <div class="camera-container" id="cameraContainer">
        <video id="video" playsinline></video>
        <div class="camera-guide"></div>
        <div class="camera-hint">Centra el codigo en el recuadro</div>
        <button type="button" class="close-camera" id="closeCamera">‚úï</button>
      </div>
    </div>

    <div class="status-message" id="statusMessage"></div>

    <!-- Input dedicado para escaneo web (lector de c√≥digo de barras) -->
    <div class="web-scanner-section hidden" id="webScannerSection">
      <div class="web-scanner-title">Escanear con lector</div>
      <input type="text" id="webScannerInput" class="web-scanner-input" placeholder="Esperando escaneo..." autocomplete="off">
      <div class="web-scanner-hint">El lector escribir√° aqu√≠ autom√°ticamente</div>
      <div class="web-scanner-status ready" id="webScannerStatus">‚úì Listo para escanear</div>
      <div class="fast-mode-container" id="fastModeContainer">
        <span class="fast-mode-label">Modo r√°pido</span>
        <div class="fast-mode-toggle" id="fastModeToggle" onclick="toggleFastMode()"></div>
      </div>
    </div>

    <!-- Lista desplegable de items escaneados -->
    <div class="scanned-dropdown hidden" id="scannedDropdown">
      <div class="scanned-dropdown-header" id="scannedDropdownHeader">
        <h3>
          <span>Items escaneados</span>
          <span class="scanned-dropdown-badge" id="scannedBadge">0/0</span>
        </h3>
        <span class="scanned-dropdown-toggle">‚ñº</span>
      </div>
      <div class="scanned-dropdown-list" id="scannedList"></div>
    </div>

    <div class="items-section hidden" id="itemsSection">
      <div class="items-header">
        <h2>Productos a verificar</h2>
        <div class="items-meta">
          <span class="items-cuenta" id="itemsCuenta">-</span>
          <span id="itemsProducto"></span>
        </div>
        <span class="items-count" id="itemsCount">0/0</span>
      </div>
      <div id="itemsList"></div>
      <div id="visionResult" class="vision-result hidden"></div>
    </div>

    <button type="button" class="reset-btn hidden" id="resetBtn">Nuevo codigo</button>
    </div><!-- fin sectionSeguimiento -->
  </div>

  <div class="complete-banner" id="completeBanner">‚úì Verificacion completa</div>
  <button type="button" id="cameraBtn" class="camera-btn">Escanear codigo</button>

  <!-- Toast para feedback r√°pido en web -->
  <div class="scan-toast" id="scanToast">
    <div id="scanToastMessage">Verificado</div>
    <div class="scan-toast-code" id="scanToastCode"></div>
    <div class="scan-toast-count" id="scanToastCount"></div>
  </div>

  <!-- Panel de verificaci√≥n de producto (web) -->
  <div class="verify-panel hidden" id="verifyPanel">
    <div class="verify-panel-header">
      <div class="verify-panel-code" id="verifyPanelCode">CODIGO</div>
      <div class="verify-panel-title" id="verifyPanelTitle">Nombre del producto</div>
      <div class="verify-panel-sku" id="verifyPanelSku">SKU</div>
      <button class="verify-panel-delete" id="verifyPanelDelete" onclick="borrarVerificacion()">BORRAR</button>
    </div>
    <div class="verify-panel-body">
      <div class="verify-panel-instruction">
        <strong>Verific√° que el producto coincida</strong><br>
        Escane√° de nuevo para confirmar cada item
      </div>
      <div class="verify-panel-items" id="verifyPanelItems"></div>
    </div>
    <div class="verify-panel-footer">
      <div class="verify-panel-progress">
        <div class="verify-panel-progress-bar">
          <div class="verify-panel-progress-fill" id="verifyPanelProgressFill" style="width: 0%"></div>
        </div>
        <div class="verify-panel-progress-text" id="verifyPanelProgressText">0/0</div>
      </div>
    </div>
  </div>

  <!-- Vision Camera Modal para verificaci√≥n con IA -->
  <div class="vision-camera-modal hidden" id="visionCameraModal">
    <div class="vision-camera-header">
      <h3>Verificar con IA</h3>
      <button type="button" class="vision-camera-close" id="visionCameraClose">‚úï</button>
    </div>
    <div class="vision-camera-body">
      <video id="visionVideo" playsinline autoplay></video>
      <div class="vision-product-info" id="visionProductInfo">
        <strong>Producto:</strong> <span id="visionProductName">-</span>
      </div>
    </div>
    <div class="vision-camera-footer">
      <button type="button" class="vision-analyze-btn" id="visionAnalyzeBtn">
        <span>üîç</span> Analizar
      </button>
    </div>
  </div>

  <!-- Canvas oculto para captura -->
  <canvas id="visionCanvas" style="display:none"></canvas>

  <!-- Modal de detalle de colecta -->
  <div class="colecta-modal hidden" id="colectaModal">
    <div class="colecta-modal-content">
      <div class="colecta-modal-header">
        <h3 id="modalColectaNombre">Colecta</h3>
        <button type="button" class="colecta-modal-close" id="modalClose">‚úï</button>
      </div>
      <div class="colecta-modal-info" id="modalColectaInfo"></div>
      <div class="colecta-modal-progress">
        <div class="colecta-modal-progress-bar">
          <div class="colecta-modal-progress-fill" id="modalProgressFill"></div>
        </div>
        <div class="colecta-modal-progress-text" id="modalProgressText"></div>
      </div>
      <div class="colecta-modal-items" id="modalColectaItems"></div>
    </div>
  </div>

  <script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="js/app.js"></script>
  <script src="js/transfer.js"></script>
  <script src="js/tabs.js"></script>
  <script src="js/planner.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js').then(function(registration) {
          console.log('SW registrado:', registration.scope);
        }).catch(function(error) {
          console.log('SW error:', error);
        });
      });
    }
  </script>
</body>
</html>
